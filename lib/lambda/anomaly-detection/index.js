"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const client_eventbridge_1 = require("@aws-sdk/client-eventbridge");
const dynamoClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(dynamoClient);
const eventBridgeClient = new client_eventbridge_1.EventBridgeClient({});
const handler = async (_event, _context) => {
    console.log('Starting anomaly detection analysis');
    const now = new Date();
    const analysisWindow = new Date(now.getTime() - (60 * 60 * 1000)); // Last hour
    const endTime = now.toISOString();
    const startTime = analysisWindow.toISOString();
    try {
        // Run all anomaly detection patterns
        const anomalies = await Promise.all([
            detectMultipleFailedLogins(startTime, endTime),
            detectUnusualIPActivity(startTime, endTime),
            detectPermissionEscalation(startTime, endTime),
            detectHighRiskEventSpikes(startTime, endTime),
            detectSuspiciousUserAgent(startTime, endTime)
        ]);
        // Flatten results
        const allAnomalies = anomalies.flat();
        if (allAnomalies.length > 0) {
            console.log(`Found ${allAnomalies.length} anomalies`);
            // Send anomaly events to EventBridge
            await sendAnomalyEvents(allAnomalies);
            // Log critical anomalies immediately
            const criticalAnomalies = allAnomalies.filter(a => a.severity === 'CRITICAL');
            if (criticalAnomalies.length > 0) {
                console.error(`CRITICAL ANOMALIES DETECTED:`, criticalAnomalies);
            }
        }
        else {
            console.log('No anomalies detected in the current time window');
        }
    }
    catch (error) {
        console.error('Anomaly detection failed:', error);
        throw error;
    }
};
exports.handler = handler;
async function detectMultipleFailedLogins(startTime, endTime) {
    // Query for failed authentication events in time window
    const params = {
        TableName: process.env.AUDIT_TABLE_NAME,
        IndexName: 'ServiceEventTypeIndex',
        KeyConditionExpression: 'serviceName = :serviceName AND eventType = :eventType',
        FilterExpression: '#timestamp BETWEEN :startTime AND :endTime AND outcome = :outcome',
        ExpressionAttributeNames: {
            '#timestamp': 'timestamp'
        },
        ExpressionAttributeValues: {
            ':serviceName': 'loupeen.auth',
            ':eventType': 'Authentication Event',
            ':startTime': startTime,
            ':endTime': endTime,
            ':outcome': 'FAILURE'
        }
    };
    const command = new lib_dynamodb_1.QueryCommand(params);
    const response = await docClient.send(command);
    const failedLogins = response.Items || [];
    // Group by principal ID
    const loginAttempts = failedLogins.reduce((acc, item) => {
        const principalId = item.principalId || 'unknown';
        if (!acc[principalId])
            acc[principalId] = [];
        acc[principalId].push(item);
        return acc;
    }, {});
    // Detect users with excessive failed attempts (>5 in an hour)
    const anomalies = [];
    Object.entries(loginAttempts).forEach(([principalId, attempts]) => {
        if (attempts.length >= 5) {
            anomalies.push({
                type: 'excessive_failed_logins',
                severity: attempts.length >= 10 ? 'CRITICAL' : 'HIGH',
                description: `User ${principalId} had ${attempts.length} failed login attempts in the last hour`,
                principalId,
                count: attempts.length,
                timeWindow: '1 hour',
                details: {
                    attempts: attempts.map(a => ({
                        timestamp: a.timestamp,
                        sourceIp: a.sourceIp,
                        userAgent: a.userAgent
                    }))
                }
            });
        }
    });
    return anomalies;
}
async function detectUnusualIPActivity(startTime, endTime) {
    // Scan for events with IP addresses in time window
    const params = {
        TableName: process.env.AUDIT_TABLE_NAME,
        FilterExpression: '#timestamp BETWEEN :startTime AND :endTime AND attribute_exists(sourceIp)',
        ExpressionAttributeNames: {
            '#timestamp': 'timestamp'
        },
        ExpressionAttributeValues: {
            ':startTime': startTime,
            ':endTime': endTime
        }
    };
    const command = new lib_dynamodb_1.ScanCommand(params);
    const response = await docClient.send(command);
    const eventsWithIP = response.Items || [];
    // Group by IP and principal
    const ipActivity = eventsWithIP.reduce((acc, item) => {
        const ip = item.sourceIp;
        if (!acc[ip])
            acc[ip] = { users: new Set(), events: [] };
        if (item.principalId)
            acc[ip].users.add(item.principalId);
        acc[ip].events.push(item);
        return acc;
    }, {});
    const anomalies = [];
    // Detect IPs with multiple users (>3 users from same IP)
    Object.entries(ipActivity).forEach(([ip, activity]) => {
        if (activity.users.size >= 3) {
            anomalies.push({
                type: 'multiple_users_same_ip',
                severity: activity.users.size >= 5 ? 'HIGH' : 'MEDIUM',
                description: `IP ${ip} used by ${activity.users.size} different users`,
                count: activity.users.size,
                timeWindow: '1 hour',
                details: {
                    ip,
                    users: Array.from(activity.users),
                    eventCount: activity.events.length
                }
            });
        }
    });
    return anomalies;
}
async function detectPermissionEscalation(startTime, endTime) {
    // Query for authorization events that might indicate privilege escalation
    const params = {
        TableName: process.env.AUDIT_TABLE_NAME,
        IndexName: 'ServiceEventTypeIndex',
        KeyConditionExpression: 'serviceName = :serviceName AND eventType = :eventType',
        FilterExpression: '#timestamp BETWEEN :startTime AND :endTime AND (contains(action, :promote) OR contains(action, :grant) OR contains(action, :admin))',
        ExpressionAttributeNames: {
            '#timestamp': 'timestamp'
        },
        ExpressionAttributeValues: {
            ':serviceName': 'loupeen.authz',
            ':eventType': 'Permission Change',
            ':startTime': startTime,
            ':endTime': endTime,
            ':promote': 'promote',
            ':grant': 'grant',
            ':admin': 'admin'
        }
    };
    const command = new lib_dynamodb_1.QueryCommand(params);
    const response = await docClient.send(command);
    const permissionChanges = response.Items || [];
    const anomalies = [];
    // Group by principal and look for rapid permission changes
    const permissionsByPrincipal = permissionChanges.reduce((acc, item) => {
        const principalId = item.principalId || 'unknown';
        if (!acc[principalId])
            acc[principalId] = [];
        acc[principalId].push(item);
        return acc;
    }, {});
    Object.entries(permissionsByPrincipal).forEach(([principalId, changes]) => {
        if (changes.length >= 3) { // 3 or more permission changes in an hour
            anomalies.push({
                type: 'rapid_permission_changes',
                severity: 'HIGH',
                description: `User ${principalId} had ${changes.length} permission changes in the last hour`,
                principalId,
                count: changes.length,
                timeWindow: '1 hour',
                details: {
                    changes: changes.map(c => ({
                        timestamp: c.timestamp,
                        action: c.action,
                        outcome: c.outcome,
                        resourceId: c.resourceId
                    }))
                }
            });
        }
    });
    return anomalies;
}
async function detectHighRiskEventSpikes(startTime, endTime) {
    // Query high-risk events
    const params = {
        TableName: process.env.AUDIT_TABLE_NAME,
        IndexName: 'RiskLevelTimeIndex',
        KeyConditionExpression: 'riskLevel = :riskLevel AND #timestamp BETWEEN :startTime AND :endTime',
        ExpressionAttributeNames: {
            '#timestamp': 'timestamp'
        },
        ExpressionAttributeValues: {
            ':riskLevel': 'HIGH',
            ':startTime': startTime,
            ':endTime': endTime
        }
    };
    const command = new lib_dynamodb_1.QueryCommand(params);
    const response = await docClient.send(command);
    const highRiskEvents = response.Items || [];
    const anomalies = [];
    // If we have more than 10 high-risk events in an hour, that's suspicious
    if (highRiskEvents.length >= 10) {
        anomalies.push({
            type: 'high_risk_event_spike',
            severity: 'CRITICAL',
            description: `Unusual spike in high-risk events: ${highRiskEvents.length} events in the last hour`,
            count: highRiskEvents.length,
            timeWindow: '1 hour',
            details: {
                eventTypes: [...new Set(highRiskEvents.map(e => e.eventType))],
                services: [...new Set(highRiskEvents.map(e => e.serviceName))]
            }
        });
    }
    return anomalies;
}
async function detectSuspiciousUserAgent(startTime, endTime) {
    // Look for suspicious user agent patterns
    const params = {
        TableName: process.env.AUDIT_TABLE_NAME,
        FilterExpression: '#timestamp BETWEEN :startTime AND :endTime AND attribute_exists(userAgent)',
        ExpressionAttributeNames: {
            '#timestamp': 'timestamp'
        },
        ExpressionAttributeValues: {
            ':startTime': startTime,
            ':endTime': endTime
        }
    };
    const command = new lib_dynamodb_1.ScanCommand(params);
    const response = await docClient.send(command);
    const eventsWithUserAgent = response.Items || [];
    const anomalies = [];
    // Look for common automation/bot patterns
    const suspiciousPatterns = [
        'curl',
        'wget',
        'python-requests',
        'bot',
        'crawler',
        'scanner'
    ];
    eventsWithUserAgent.forEach(event => {
        const userAgent = event.userAgent?.toLowerCase() || '';
        const hasSuspiciousPattern = suspiciousPatterns.some(pattern => userAgent.includes(pattern));
        if (hasSuspiciousPattern) {
            anomalies.push({
                type: 'suspicious_user_agent',
                severity: 'MEDIUM',
                description: `Suspicious user agent detected: ${event.userAgent}`,
                principalId: event.principalId,
                timeWindow: '1 hour',
                details: {
                    userAgent: event.userAgent,
                    sourceIp: event.sourceIp,
                    eventType: event.eventType,
                    timestamp: event.timestamp
                }
            });
        }
    });
    return anomalies;
}
async function sendAnomalyEvents(anomalies) {
    const events = anomalies.map(anomaly => ({
        Source: 'loupeen.security',
        DetailType: 'Anomaly Detection',
        Detail: JSON.stringify({
            ...anomaly,
            detectedAt: new Date().toISOString(),
            riskLevel: anomaly.severity
        }),
        Time: new Date()
    }));
    // Send in batches of 10 (EventBridge limit)
    const batches = [];
    for (let i = 0; i < events.length; i += 10) {
        batches.push(events.slice(i, i + 10));
    }
    for (const batch of batches) {
        const command = new client_eventbridge_1.PutEventsCommand({
            Entries: batch
        });
        await eventBridgeClient.send(command);
    }
    console.log(`Sent ${anomalies.length} anomaly events to EventBridge`);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9sYW1iZGEvYW5vbWFseS1kZXRlY3Rpb24vaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsOERBQTBEO0FBQzFELHdEQUEwRjtBQUMxRixvRUFBa0Y7QUFHbEYsTUFBTSxZQUFZLEdBQUcsSUFBSSxnQ0FBYyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQzVDLE1BQU0sU0FBUyxHQUFHLHFDQUFzQixDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztBQUM1RCxNQUFNLGlCQUFpQixHQUFHLElBQUksc0NBQWlCLENBQUMsRUFBRSxDQUFDLENBQUM7QUFZN0MsTUFBTSxPQUFPLEdBQWtDLEtBQUssRUFDekQsTUFBc0IsRUFDdEIsUUFBaUIsRUFDRixFQUFFO0lBQ2pCLE9BQU8sQ0FBQyxHQUFHLENBQUMscUNBQXFDLENBQUMsQ0FBQztJQUVuRCxNQUFNLEdBQUcsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDO0lBQ3ZCLE1BQU0sY0FBYyxHQUFHLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLFlBQVk7SUFDL0UsTUFBTSxPQUFPLEdBQUcsR0FBRyxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQ2xDLE1BQU0sU0FBUyxHQUFHLGNBQWMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUUvQyxJQUFJLENBQUM7UUFDSCxxQ0FBcUM7UUFDckMsTUFBTSxTQUFTLEdBQUcsTUFBTSxPQUFPLENBQUMsR0FBRyxDQUFDO1lBQ2xDLDBCQUEwQixDQUFDLFNBQVMsRUFBRSxPQUFPLENBQUM7WUFDOUMsdUJBQXVCLENBQUMsU0FBUyxFQUFFLE9BQU8sQ0FBQztZQUMzQywwQkFBMEIsQ0FBQyxTQUFTLEVBQUUsT0FBTyxDQUFDO1lBQzlDLHlCQUF5QixDQUFDLFNBQVMsRUFB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RSxDQUFDLEdBQUcsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDLElBQUksRUFBRSxFQUFFLENBQUM7UUFDM0MsT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUN4QyxDQUFDO0lBRUQsS0FBSyxNQUFNLEtBQUssSUFBSSxPQUFPLEVBQUUsQ0FBQztRQUM1QixNQUFNLE9BQU8sR0FBRyxJQUFJLHFDQUFnQixDQUFDO1lBQ25DLE9BQU8sRUFBRSxLQUFLO1NBQ2YsQ0FBQyxDQUFDO1FBRUgsTUFBTSxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDeEMsQ0FBQztJQUVELE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxTQUFTLENBQUMsTUFBTSxnQ0FBZ0MsQ0FBQyxDQUFDO0FBQ3hFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEeW5hbW9EQkNsaWVudCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1keW5hbW9kYic7XG5pbXBvcnQgeyBEeW5hbW9EQkRvY3VtZW50Q2xpZW50LCBRdWVyeUNvbW1hbmQsIFNjYW5Db21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvbGliLWR5bmFtb2RiJztcbmltcG9ydCB7IEV2ZW50QnJpZGdlQ2xpZW50LCBQdXRFdmVudHNDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWV2ZW50YnJpZGdlJztcbmltcG9ydCB7IFNjaGVkdWxlZEV2ZW50LCBDb250ZXh0LCBIYW5kbGVyIH0gZnJvbSAnYXdzLWxhbWJkYSc7XG5cbmNvbnN0IGR5bmFtb0NsaWVudCA9IG5ldyBEeW5hbW9EQkNsaWVudCh7fSk7XG5jb25zdCBkb2NDbGllbnQgPSBEeW5hbW9EQkRvY3VtZW50Q2xpZW50LmZyb20oZHluYW1vQ2xpZW50KTtcbmNvbnN0IGV2ZW50QnJpZGdlQ2xpZW50ID0gbmV3IEV2ZW50QnJpZGdlQ2xpZW50KHt9KTtcblxuaW50ZXJmYWNlIEFub21hbHlQYXR0ZXJuIHtcbiAgdHlwZTogc3RyaW5nO1xuICBzZXZlcml0eTogJ0xPVycgfCAnTUVESVVNJyB8ICdISUdIJyB8ICdDUklUSUNBTCc7XG4gIGRlc2NyaXB0aW9uOiBzdHJpbmc7XG4gIHByaW5jaXBhbElkPzogc3RyaW5nO1xuICBjb3VudD86IG51bWJlcjtcbiAgdGltZVdpbmRvdz86IHN0cmluZztcbiAgZGV0YWlsczogUmVjb3JkPHN0cmluZywgYW55Pjtcbn1cblxuZXhwb3J0IGNvbnN0IGhhbmRsZXI6IEhhbmRsZXI8U2NoZWR1bGVkRXZlbnQsIHZvaWQ+ID0gYXN5bmMgKFxuICBfZXZlbnQ6IFNjaGVkdWxlZEV2ZW50LFxuICBfY29udGV4dDogQ29udGV4dFxuKTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gIGNvbnNvbGUubG9nKCdTdGFydGluZyBhbm9tYWx5IGRldGVjdGlvbiBhbmFseXNpcycpO1xuICBcbiAgY29uc3Qgbm93ID0gbmV3IERhdGUoKTtcbiAgY29uc3QgYW5hbHlzaXNXaW5kb3cgPSBuZXcgRGF0ZShub3cuZ2V0VGltZSgpIC0gKDYwICogNjAgKiAxMDAwKSk7IC8vIExhc3QgaG91clxuICBjb25zdCBlbmRUaW1lID0gbm93LnRvSVNPU3RyaW5nKCk7XG4gIGNvbnN0IHN0YXJ0VGltZSA9IGFuYWx5c2lzV2luZG93LnRvSVNPU3RyaW5nKCk7XG4gIFxuICB0cnkge1xuICAgIC8vIFJ1biBhbGwgYW5vbWFseSBkZXRlY3Rpb24gcGF0dGVybnNcbiAgICBjb25zdCBhbm9tYWxpZXMgPSBhd2FpdCBQcm9taXNlLmFsbChbXG4gICAgICBkZXRlY3RNdWx0aXBsZUZhaWxlZExvZ2lucyhzdGFydFRpbWUsIGVuZFRpbWUpLFxuICAgICAgZGV0ZWN0VW51c3VhbElQQWN0aXZpdHkoc3RhcnRUaW1lLCBlbmRUaW1lKSxcbiAgICAgIGRldGVjdFBlcm1pc3Npb25Fc2NhbGF0aW9uKHN0YXJ0VGltZSwgZW5kVGltZSksXG4gICAgICBkZXRlY3RIaWdoUmlza0V2ZW50U3Bpa2VzKHN0YXJ0VGltZSwgZW5kVGltZSksXG4gICAgICBkZXRlY3RTdXNwaWNpb3VzVXNlckFnZW50KHN0YXJ0VGltZSwgZW5kVGltZSlcbiAgICBdKTtcbiAgICBcbiAgICAvLyBGbGF0dGVuIHJlc3VsdHNcbiAgICBjb25zdCBhbGxBbm9tYWxpZXMgPSBhbm9tYWxpZXMuZmxhdCgpO1xuICAgIFxuICAgIGlmIChhbGxBbm9tYWxpZXMubGVuZ3RoID4gMCkge1xuICAgICAgY29uc29sZS5sb2coYEZvdW5kICR7YWxsQW5vbWFsaWVzLmxlbmd0aH0gYW5vbWFsaWVzYCk7XG4gICAgICBcbiAgICAgIC8vIFNlbmQgYW5vbWFseSBldmVudHMgdG8gRXZlbnRCcmlkZ2VcbiAgICAgIGF3YWl0IHNlbmRBbm9tYWx5RXZlbnRzKGFsbEFub21hbGllcyk7XG4gICAgICBcbiAgICAgIC8vIExvZyBjcml0aWNhbCBhbm9tYWxpZXMgaW1tZWRpYXRlbHlcbiAgICAgIGNvbnN0IGNyaXRpY2FsQW5vbWFsaWVzID0gYWxsQW5vbWFsaWVzLmZpbHRlcihhID0+IGEuc2V2ZXJpdHkgPT09ICdDUklUSUNBTCcpO1xuICAgICAgaWYgKGNyaXRpY2FsQW5vbWFsaWVzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihgQ1JJVElDQUwgQU5PTUFMSUVTIERFVEVDVEVEOmAsIGNyaXRpY2FsQW5vbWFsaWVzKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgY29uc29sZS5sb2coJ05vIGFub21hbGllcyBkZXRlY3RlZCBpbiB0aGUgY3VycmVudCB0aW1lIHdpbmRvdycpO1xuICAgIH1cbiAgICBcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdBbm9tYWx5IGRldGVjdGlvbiBmYWlsZWQ6JywgZXJyb3IpO1xuICAgIHRocm93IGVycm9yO1xuICB9XG59O1xuXG5hc3luYyBmdW5jdGlvbiBkZXRlY3RNdWx0aXBsZUZhaWxlZExvZ2lucyhzdGFydFRpbWU6IHN0cmluZywgZW5kVGltZTogc3RyaW5nKTogUHJvbWlzZTxBbm9tYWx5UGF0dGVybltdPiB7XG4gIC8vIFF1ZXJ5IGZvciBmYWlsZWQgYXV0aGVudGljYXRpb24gZXZlbnRzIGluIHRpbWUgd2luZG93XG4gIGNvbnN0IHBhcmFtcyA9IHtcbiAgICBUYWJsZU5hbWU6IHByb2Nlc3MuZW52LkFVRElUX1RBQkxFX05BTUUhLFxuICAgIEluZGV4TmFtZTogJ1NlcnZpY2VFdmVudFR5cGVJbmRleCcsXG4gICAgS2V5Q29uZGl0aW9uRXhwcmVzc2lvbjogJ3NlcnZpY2VOYW1lID0gOnNlcnZpY2VOYW1lIEFORCBldmVudFR5cGUgPSA6ZXZlbnRUeXBlJyxcbiAgICBGaWx0ZXJFeHByZXNzaW9uOiAnI3RpbWVzdGFtcCBCRVRXRUVOIDpzdGFydFRpbWUgQU5EIDplbmRUaW1lIEFORCBvdXRjb21lID0gOm91dGNvbWUnLFxuICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczoge1xuICAgICAgJyN0aW1lc3RhbXAnOiAndGltZXN0YW1wJ1xuICAgIH0sXG4gICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xuICAgICAgJzpzZXJ2aWNlTmFtZSc6ICdsb3VwZWVuLmF1dGgnLFxuICAgICAgJzpldmVudFR5cGUnOiAnQXV0aGVudGljYXRpb24gRXZlbnQnLFxuICAgICAgJzpzdGFydFRpbWUnOiBzdGFydFRpbWUsXG4gICAgICAnOmVuZFRpbWUnOiBlbmRUaW1lLFxuICAgICAgJzpvdXRjb21lJzogJ0ZBSUxVUkUnXG4gICAgfVxuICB9O1xuICBcbiAgY29uc3QgY29tbWFuZCA9IG5ldyBRdWVyeUNvbW1hbmQocGFyYW1zKTtcbiAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChjb21tYW5kKTtcbiAgY29uc3QgZmFpbGVkTG9naW5zID0gcmVzcG9uc2UuSXRlbXMgfHwgW107XG4gIFxuICAvLyBHcm91cCBieSBwcmluY2lwYWwgSURcbiAgY29uc3QgbG9naW5BdHRlbXB0cyA9IGZhaWxlZExvZ2lucy5yZWR1Y2UoKGFjYzogUmVjb3JkPHN0cmluZywgYW55W10+LCBpdGVtOiBhbnkpID0+IHtcbiAgICBjb25zdCBwcmluY2lwYWxJZCA9IGl0ZW0ucHJpbmNpcGFsSWQgfHwgJ3Vua25vd24nO1xuICAgIGlmICghYWNjW3ByaW5jaXBhbElkXSkgYWNjW3ByaW5jaXBhbElkXSA9IFtdO1xuICAgIGFjY1twcmluY2lwYWxJZF0ucHVzaChpdGVtKTtcbiAgICByZXR1cm4gYWNjO1xuICB9LCB7fSk7XG4gIFxuICAvLyBEZXRlY3QgdXNlcnMgd2l0aCBleGNlc3NpdmUgZmFpbGVkIGF0dGVtcHRzICg+NSBpbiBhbiBob3VyKVxuICBjb25zdCBhbm9tYWxpZXM6IEFub21hbHlQYXR0ZXJuW10gPSBbXTtcbiAgT2JqZWN0LmVudHJpZXMobG9naW5BdHRlbXB0cykuZm9yRWFjaCgoW3ByaW5jaXBhbElkLCBhdHRlbXB0c10pID0+IHtcbiAgICBpZiAoYXR0ZW1wdHMubGVuZ3RoID49IDUpIHtcbiAgICAgIGFub21hbGllcy5wdXNoKHtcbiAgICAgICAgdHlwZTogJ2V4Y2Vzc2l2ZV9mYWlsZWRfbG9naW5zJyxcbiAgICAgICAgc2V2ZXJpdHk6IGF0dGVtcHRzLmxlbmd0aCA+PSAxMCA/ICdDUklUSUNBTCcgOiAnSElHSCcsXG4gICAgICAgIGRlc2NyaXB0aW9uOiBgVXNlciAke3ByaW5jaXBhbElkfSBoYWQgJHthdHRlbXB0cy5sZW5ndGh9IGZhaWxlZCBsb2dpbiBhdHRlbXB0cyBpbiB0aGUgbGFzdCBob3VyYCxcbiAgICAgICAgcHJpbmNpcGFsSWQsXG4gICAgICAgIGNvdW50OiBhdHRlbXB0cy5sZW5ndGgsXG4gICAgICAgIHRpbWVXaW5kb3c6ICcxIGhvdXInLFxuICAgICAgICBkZXRhaWxzOiB7XG4gICAgICAgICAgYXR0ZW1wdHM6IGF0dGVtcHRzLm1hcChhID0+ICh7XG4gICAgICAgICAgICB0aW1lc3RhbXA6IGEudGltZXN0YW1wLFxuICAgICAgICAgICAgc291cmNlSXA6IGEuc291cmNlSXAsXG4gICAgICAgICAgICB1c2VyQWdlbnQ6IGEudXNlckFnZW50XG4gICAgICAgICAgfSkpXG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgfSk7XG4gIFxuICByZXR1cm4gYW5vbWFsaWVzO1xufVxuXG5hc3luYyBmdW5jdGlvbiBkZXRlY3RVbnVzdWFsSVBBY3Rpdml0eShzdGFydFRpbWU6IHN0cmluZywgZW5kVGltZTogc3RyaW5nKTogUHJvbWlzZTxBbm9tYWx5UGF0dGVybltdPiB7XG4gIC8vIFNjYW4gZm9yIGV2ZW50cyB3aXRoIElQIGFkZHJlc3NlcyBpbiB0aW1lIHdpbmRvd1xuICBjb25zdCBwYXJhbXMgPSB7XG4gICAgVGFibGVOYW1lOiBwcm9jZXNzLmVudi5BVURJVF9UQUJMRV9OQU1FISxcbiAgICBGaWx0ZXJFeHByZXNzaW9uOiAnI3RpbWVzdGFtcCBCRVRXRUVOIDpzdGFydFRpbWUgQU5EIDplbmRUaW1lIEFORCBhdHRyaWJ1dGVfZXhpc3RzKHNvdXJjZUlwKScsXG4gICAgRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiB7XG4gICAgICAnI3RpbWVzdGFtcCc6ICd0aW1lc3RhbXAnXG4gICAgfSxcbiAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAnOnN0YXJ0VGltZSc6IHN0YXJ0VGltZSxcbiAgICAgICc6ZW5kVGltZSc6IGVuZFRpbWVcbiAgICB9XG4gIH07XG4gIFxuICBjb25zdCBjb21tYW5kID0gbmV3IFNjYW5Db21tYW5kKHBhcmFtcyk7XG4gIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZG9jQ2xpZW50LnNlbmQoY29tbWFuZCk7XG4gIGNvbnN0IGV2ZW50c1dpdGhJUCA9IHJlc3BvbnNlLkl0ZW1zIHx8IFtdO1xuICBcbiAgLy8gR3JvdXAgYnkgSVAgYW5kIHByaW5jaXBhbFxuICBjb25zdCBpcEFjdGl2aXR5ID0gZXZlbnRzV2l0aElQLnJlZHVjZSgoYWNjOiBSZWNvcmQ8c3RyaW5nLCBhbnk+LCBpdGVtOiBhbnkpID0+IHtcbiAgICBjb25zdCBpcCA9IGl0ZW0uc291cmNlSXA7XG4gICAgaWYgKCFhY2NbaXBdKSBhY2NbaXBdID0geyB1c2VyczogbmV3IFNldCgpLCBldmVudHM6IFtdIH07XG4gICAgaWYgKGl0ZW0ucHJpbmNpcGFsSWQpIGFjY1tpcF0udXNlcnMuYWRkKGl0ZW0ucHJpbmNpcGFsSWQpO1xuICAgIGFjY1tpcF0uZXZlbnRzLnB1c2goaXRlbSk7XG4gICAgcmV0dXJuIGFjYztcbiAgfSwge30pO1xuICBcbiAgY29uc3QgYW5vbWFsaWVzOiBBbm9tYWx5UGF0dGVybltdID0gW107XG4gIFxuICAvLyBEZXRlY3QgSVBzIHdpdGggbXVsdGlwbGUgdXNlcnMgKD4zIHVzZXJzIGZyb20gc2FtZSBJUClcbiAgT2JqZWN0LmVudHJpZXMoaXBBY3Rpdml0eSkuZm9yRWFjaCgoW2lwLCBhY3Rpdml0eV06IFtzdHJpbmcsIGFueV0pID0+IHtcbiAgICBpZiAoYWN0aXZpdHkudXNlcnMuc2l6ZSA+PSAzKSB7XG4gICAgICBhbm9tYWxpZXMucHVzaCh7XG4gICAgICAgIHR5cGU6ICdtdWx0aXBsZV91c2Vyc19zYW1lX2lwJyxcbiAgICAgICAgc2V2ZXJpdHk6IGFjdGl2aXR5LnVzZXJzLnNpemUgPj0gNSA/ICdISUdIJyA6ICdNRURJVU0nLFxuICAgICAgICBkZXNjcmlwdGlvbjogYElQICR7aXB9IHVzZWQgYnkgJHthY3Rpdml0eS51c2Vycy5zaXplfSBkaWZmZXJlbnQgdXNlcnNgLFxuICAgICAgICBjb3VudDogYWN0aXZpdHkudXNlcnMuc2l6ZSxcbiAgICAgICAgdGltZVdpbmRvdzogJzEgaG91cicsXG4gICAgICAgIGRldGFpbHM6IHtcbiAgICAgICAgICBpcCxcbiAgICAgICAgICB1c2VyczogQXJyYXkuZnJvbShhY3Rpdml0eS51c2VycyksXG4gICAgICAgICAgZXZlbnRDb3VudDogYWN0aXZpdHkuZXZlbnRzLmxlbmd0aFxuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH0pO1xuICBcbiAgcmV0dXJuIGFub21hbGllcztcbn1cblxuYXN5bmMgZnVuY3Rpb24gZGV0ZWN0UGVybWlzc2lvbkVzY2FsYXRpb24oc3RhcnRUaW1lOiBzdHJpbmcsIGVuZFRpbWU6IHN0cmluZyk6IFByb21pc2U8QW5vbWFseVBhdHRlcm5bXT4ge1xuICAvLyBRdWVyeSBmb3IgYXV0aG9yaXphdGlvbiBldmVudHMgdGhhdCBtaWdodCBpbmRpY2F0ZSBwcml2aWxlZ2UgZXNjYWxhdGlvblxuICBjb25zdCBwYXJhbXMgPSB7XG4gICAgVGFibGVOYW1lOiBwcm9jZXNzLmVudi5BVURJVF9UQUJMRV9OQU1FISxcbiAgICBJbmRleE5hbWU6ICdTZXJ2aWNlRXZlbnRUeXBlSW5kZXgnLFxuICAgIEtleUNvbmRpdGlvbkV4cHJlc3Npb246ICdzZXJ2aWNlTmFtZSA9IDpzZXJ2aWNlTmFtZSBBTkQgZXZlbnRUeXBlID0gOmV2ZW50VHlwZScsXG4gICAgRmlsdGVyRXhwcmVzc2lvbjogJyN0aW1lc3RhbXAgQkVUV0VFTiA6c3RhcnRUaW1lIEFORCA6ZW5kVGltZSBBTkQgKGNvbnRhaW5zKGFjdGlvbiwgOnByb21vdGUpIE9SIGNvbnRhaW5zKGFjdGlvbiwgOmdyYW50KSBPUiBjb250YWlucyhhY3Rpb24sIDphZG1pbikpJyxcbiAgICBFeHByZXNzaW9uQXR0cmlidXRlTmFtZXM6IHtcbiAgICAgICcjdGltZXN0YW1wJzogJ3RpbWVzdGFtcCdcbiAgICB9LFxuICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcbiAgICAgICc6c2VydmljZU5hbWUnOiAnbG91cGVlbi5hdXRoeicsXG4gICAgICAnOmV2ZW50VHlwZSc6ICdQZXJtaXNzaW9uIENoYW5nZScsXG4gICAgICAnOnN0YXJ0VGltZSc6IHN0YXJ0VGltZSxcbiAgICAgICc6ZW5kVGltZSc6IGVuZFRpbWUsXG4gICAgICAnOnByb21vdGUnOiAncHJvbW90ZScsXG4gICAgICAnOmdyYW50JzogJ2dyYW50JyxcbiAgICAgICc6YWRtaW4nOiAnYWRtaW4nXG4gICAgfVxuICB9O1xuICBcbiAgY29uc3QgY29tbWFuZCA9IG5ldyBRdWVyeUNvbW1hbmQocGFyYW1zKTtcbiAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChjb21tYW5kKTtcbiAgY29uc3QgcGVybWlzc2lvbkNoYW5nZXMgPSByZXNwb25zZS5JdGVtcyB8fCBbXTtcbiAgXG4gIGNvbnN0IGFub21hbGllczogQW5vbWFseVBhdHRlcm5bXSA9IFtdO1xuICBcbiAgLy8gR3JvdXAgYnkgcHJpbmNpcGFsIGFuZCBsb29rIGZvciByYXBpZCBwZXJtaXNzaW9uIGNoYW5nZXNcbiAgY29uc3QgcGVybWlzc2lvbnNCeVByaW5jaXBhbCA9IHBlcm1pc3Npb25DaGFuZ2VzLnJlZHVjZSgoYWNjOiBSZWNvcmQ8c3RyaW5nLCBhbnlbXT4sIGl0ZW06IGFueSkgPT4ge1xuICAgIGNvbnN0IHByaW5jaXBhbElkID0gaXRlbS5wcmluY2lwYWxJZCB8fCAndW5rbm93bic7XG4gICAgaWYgKCFhY2NbcHJpbmNpcGFsSWRdKSBhY2NbcHJpbmNpcGFsSWRdID0gW107XG4gICAgYWNjW3ByaW5jaXBhbElkXS5wdXNoKGl0ZW0pO1xuICAgIHJldHVybiBhY2M7XG4gIH0sIHt9KTtcbiAgXG4gIE9iamVjdC5lbnRyaWVzKHBlcm1pc3Npb25zQnlQcmluY2lwYWwpLmZvckVhY2goKFtwcmluY2lwYWxJZCwgY2hhbmdlc10pID0+IHtcbiAgICBpZiAoY2hhbmdlcy5sZW5ndGggPj0gMykgeyAvLyAzIG9yIG1vcmUgcGVybWlzc2lvbiBjaGFuZ2VzIGluIGFuIGhvdXJcbiAgICAgIGFub21hbGllcy5wdXNoKHtcbiAgICAgICAgdHlwZTogJ3JhcGlkX3Blcm1pc3Npb25fY2hhbmdlcycsXG4gICAgICAgIHNldmVyaXR5OiAnSElHSCcsXG4gICAgICAgIGRlc2NyaXB0aW9uOiBgVXNlciAke3ByaW5jaXBhbElkfSBoYWQgJHtjaGFuZ2VzLmxlbmd0aH0gcGVybWlzc2lvbiBjaGFuZ2VzIGluIHRoZSBsYXN0IGhvdXJgLFxuICAgICAgICBwcmluY2lwYWxJZCxcbiAgICAgICAgY291bnQ6IGNoYW5nZXMubGVuZ3RoLFxuICAgICAgICB0aW1lV2luZG93OiAnMSBob3VyJyxcbiAgICAgICAgZGV0YWlsczoge1xuICAgICAgICAgIGNoYW5nZXM6IGNoYW5nZXMubWFwKGMgPT4gKHtcbiAgICAgICAgICAgIHRpbWVzdGFtcDogYy50aW1lc3RhbXAsXG4gICAgICAgICAgICBhY3Rpb246IGMuYWN0aW9uLFxuICAgICAgICAgICAgb3V0Y29tZTogYy5vdXRjb21lLFxuICAgICAgICAgICAgcmVzb3VyY2VJZDogYy5yZXNvdXJjZUlkXG4gICAgICAgICAgfSkpXG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgfSk7XG4gIFxuICByZXR1cm4gYW5vbWFsaWVzO1xufVxuXG5hc3luYyBmdW5jdGlvbiBkZXRlY3RIaWdoUmlza0V2ZW50U3Bpa2VzKHN0YXJ0VGltZTogc3RyaW5nLCBlbmRUaW1lOiBzdHJpbmcpOiBQcm9taXNlPEFub21hbHlQYXR0ZXJuW10+IHtcbiAgLy8gUXVlcnkgaGlnaC1yaXNrIGV2ZW50c1xuICBjb25zdCBwYXJhbXMgPSB7XG4gICAgVGFibGVOYW1lOiBwcm9jZXNzLmVudi5BVURJVF9UQUJMRV9OQU1FISxcbiAgICBJbmRleE5hbWU6ICdSaXNrTGV2ZWxUaW1lSW5kZXgnLFxuICAgIEtleUNvbmRpdGlvbkV4cHJlc3Npb246ICdyaXNrTGV2ZWwgPSA6cmlza0xldmVsIEFORCAjdGltZXN0YW1wIEJFVFdFRU4gOnN0YXJ0VGltZSBBTkQgOmVuZFRpbWUnLFxuICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczoge1xuICAgICAgJyN0aW1lc3RhbXAnOiAndGltZXN0YW1wJ1xuICAgIH0sXG4gICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xuICAgICAgJzpyaXNrTGV2ZWwnOiAnSElHSCcsXG4gICAgICAnOnN0YXJ0VGltZSc6IHN0YXJ0VGltZSxcbiAgICAgICc6ZW5kVGltZSc6IGVuZFRpbWVcbiAgICB9XG4gIH07XG4gIFxuICBjb25zdCBjb21tYW5kID0gbmV3IFF1ZXJ5Q29tbWFuZChwYXJhbXMpO1xuICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKGNvbW1hbmQpO1xuICBjb25zdCBoaWdoUmlza0V2ZW50cyA9IHJlc3BvbnNlLkl0ZW1zIHx8IFtdO1xuICBcbiAgY29uc3QgYW5vbWFsaWVzOiBBbm9tYWx5UGF0dGVybltdID0gW107XG4gIFxuICAvLyBJZiB3ZSBoYXZlIG1vcmUgdGhhbiAxMCBoaWdoLXJpc2sgZXZlbnRzIGluIGFuIGhvdXIsIHRoYXQncyBzdXNwaWNpb3VzXG4gIGlmIChoaWdoUmlza0V2ZW50cy5sZW5ndGggPj0gMTApIHtcbiAgICBhbm9tYWxpZXMucHVzaCh7XG4gICAgICB0eXBlOiAnaGlnaF9yaXNrX2V2ZW50X3NwaWtlJyxcbiAgICAgIHNldmVyaXR5OiAnQ1JJVElDQUwnLFxuICAgICAgZGVzY3JpcHRpb246IGBVbnVzdWFsIHNwaWtlIGluIGhpZ2gtcmlzayBldmVudHM6ICR7aGlnaFJpc2tFdmVudHMubGVuZ3RofSBldmVudHMgaW4gdGhlIGxhc3QgaG91cmAsXG4gICAgICBjb3VudDogaGlnaFJpc2tFdmVudHMubGVuZ3RoLFxuICAgICAgdGltZVdpbmRvdzogJzEgaG91cicsXG4gICAgICBkZXRhaWxzOiB7XG4gICAgICAgIGV2ZW50VHlwZXM6IFsuLi5uZXcgU2V0KGhpZ2hSaXNrRXZlbnRzLm1hcChlID0+IGUuZXZlbnRUeXBlKSldLFxuICAgICAgICBzZXJ2aWNlczogWy4uLm5ldyBTZXQoaGlnaFJpc2tFdmVudHMubWFwKGUgPT4gZS5zZXJ2aWNlTmFtZSkpXVxuICAgICAgfVxuICAgIH0pO1xuICB9XG4gIFxuICByZXR1cm4gYW5vbWFsaWVzO1xufVxuXG5hc3luYyBmdW5jdGlvbiBkZXRlY3RTdXNwaWNpb3VzVXNlckFnZW50KHN0YXJ0VGltZTogc3RyaW5nLCBlbmRUaW1lOiBzdHJpbmcpOiBQcm9taXNlPEFub21hbHlQYXR0ZXJuW10+IHtcbiAgLy8gTG9vayBmb3Igc3VzcGljaW91cyB1c2VyIGFnZW50IHBhdHRlcm5zXG4gIGNvbnN0IHBhcmFtcyA9IHtcbiAgICBUYWJsZU5hbWU6IHByb2Nlc3MuZW52LkFVRElUX1RBQkxFX05BTUUhLFxuICAgIEZpbHRlckV4cHJlc3Npb246ICcjdGltZXN0YW1wIEJFVFdFRU4gOnN0YXJ0VGltZSBBTkQgOmVuZFRpbWUgQU5EIGF0dHJpYnV0ZV9leGlzdHModXNlckFnZW50KScsXG4gICAgRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiB7XG4gICAgICAnI3RpbWVzdGFtcCc6ICd0aW1lc3RhbXAnXG4gICAgfSxcbiAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAnOnN0YXJ0VGltZSc6IHN0YXJ0VGltZSxcbiAgICAgICc6ZW5kVGltZSc6IGVuZFRpbWVcbiAgICB9XG4gIH07XG4gIFxuICBjb25zdCBjb21tYW5kID0gbmV3IFNjYW5Db21tYW5kKHBhcmFtcyk7XG4gIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZG9jQ2xpZW50LnNlbmQoY29tbWFuZCk7XG4gIGNvbnN0IGV2ZW50c1dpdGhVc2VyQWdlbnQgPSByZXNwb25zZS5JdGVtcyB8fCBbXTtcbiAgXG4gIGNvbnN0IGFub21hbGllczogQW5vbWFseVBhdHRlcm5bXSA9IFtdO1xuICBcbiAgLy8gTG9vayBmb3IgY29tbW9uIGF1dG9tYXRpb24vYm90IHBhdHRlcm5zXG4gIGNvbnN0IHN1c3BpY2lvdXNQYXR0ZXJucyA9IFtcbiAgICAnY3VybCcsXG4gICAgJ3dnZXQnLFxuICAgICdweXRob24tcmVxdWVzdHMnLFxuICAgICdib3QnLFxuICAgICdjcmF3bGVyJyxcbiAgICAnc2Nhbm5lcidcbiAgXTtcbiAgXG4gIGV2ZW50c1dpdGhVc2VyQWdlbnQuZm9yRWFjaChldmVudCA9PiB7XG4gICAgY29uc3QgdXNlckFnZW50ID0gZXZlbnQudXNlckFnZW50Py50b0xvd2VyQ2FzZSgpIHx8ICcnO1xuICAgIGNvbnN0IGhhc1N1c3BpY2lvdXNQYXR0ZXJuID0gc3VzcGljaW91c1BhdHRlcm5zLnNvbWUocGF0dGVybiA9PiB1c2VyQWdlbnQuaW5jbHVkZXMocGF0dGVybikpO1xuICAgIFxuICAgIGlmIChoYXNTdXNwaWNpb3VzUGF0dGVybikge1xuICAgICAgYW5vbWFsaWVzLnB1c2goe1xuICAgICAgICB0eXBlOiAnc3VzcGljaW91c191c2VyX2FnZW50JyxcbiAgICAgICAgc2V2ZXJpdHk6ICdNRURJVU0nLFxuICAgICAgICBkZXNjcmlwdGlvbjogYFN1c3BpY2lvdXMgdXNlciBhZ2VudCBkZXRlY3RlZDogJHtldmVudC51c2VyQWdlbnR9YCxcbiAgICAgICAgcHJpbmNpcGFsSWQ6IGV2ZW50LnByaW5jaXBhbElkLFxuICAgICAgICB0aW1lV2luZG93OiAnMSBob3VyJyxcbiAgICAgICAgZGV0YWlsczoge1xuICAgICAgICAgIHVzZXJBZ2VudDogZXZlbnQudXNlckFnZW50LFxuICAgICAgICAgIHNvdXJjZUlwOiBldmVudC5zb3VyY2VJcCxcbiAgICAgICAgICBldmVudFR5cGU6IGV2ZW50LmV2ZW50VHlwZSxcbiAgICAgICAgICB0aW1lc3RhbXA6IGV2ZW50LnRpbWVzdGFtcFxuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH0pO1xuICBcbiAgcmV0dXJuIGFub21hbGllcztcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2VuZEFub21hbHlFdmVudHMoYW5vbWFsaWVzOiBBbm9tYWx5UGF0dGVybltdKTogUHJvbWlzZTx2b2lkPiB7XG4gIGNvbnN0IGV2ZW50cyA9IGFub21hbGllcy5tYXAoYW5vbWFseSA9PiAoe1xuICAgIFNvdXJjZTogJ2xvdXBlZW4uc2VjdXJpdHknLFxuICAgIERldGFpbFR5cGU6ICdBbm9tYWx5IERldGVjdGlvbicsXG4gICAgRGV0YWlsOiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAuLi5hbm9tYWx5LFxuICAgICAgZGV0ZWN0ZWRBdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgcmlza0xldmVsOiBhbm9tYWx5LnNldmVyaXR5XG4gICAgfSksXG4gICAgVGltZTogbmV3IERhdGUoKVxuICB9KSk7XG4gIFxuICAvLyBTZW5kIGluIGJhdGNoZXMgb2YgMTAgKEV2ZW50QnJpZGdlIGxpbWl0KVxuICBjb25zdCBiYXRjaGVzID0gW107XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgZXZlbnRzLmxlbmd0aDsgaSArPSAxMCkge1xuICAgIGJhdGNoZXMucHVzaChldmVudHMuc2xpY2UoaSwgaSArIDEwKSk7XG4gIH1cbiAgXG4gIGZvciAoY29uc3QgYmF0Y2ggb2YgYmF0Y2hlcykge1xuICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgUHV0RXZlbnRzQ29tbWFuZCh7XG4gICAgICBFbnRyaWVzOiBiYXRjaFxuICAgIH0pO1xuICAgIFxuICAgIGF3YWl0IGV2ZW50QnJpZGdlQ2xpZW50LnNlbmQoY29tbWFuZCk7XG4gIH1cbiAgXG4gIGNvbnNvbGUubG9nKGBTZW50ICR7YW5vbWFsaWVzLmxlbmd0aH0gYW5vbWFseSBldmVudHMgdG8gRXZlbnRCcmlkZ2VgKTtcbn0iXX0=