"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const zod_1 = require("zod");
const dynamoClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(dynamoClient);
const QueryParamsSchema = zod_1.z.object({
    queryType: zod_1.z.enum(['byPrincipal', 'byService', 'byRiskLevel', 'byTimeRange']),
    principalId: zod_1.z.string().optional(),
    serviceName: zod_1.z.string().optional(),
    eventType: zod_1.z.string().optional(),
    riskLevel: zod_1.z.enum(['LOW', 'MEDIUM', 'HIGH', 'CRITICAL']).optional(),
    startTime: zod_1.z.string().optional(),
    endTime: zod_1.z.string().optional(),
    limit: zod_1.z.string().optional(),
    nextToken: zod_1.z.string().optional()
});
const handler = async (event, context) => {
    console.log('Processing audit query:', JSON.stringify(event.queryStringParameters, null, 2));
    try {
        // Parse and validate query parameters
        const queryParams = QueryParamsSchema.parse(event.queryStringParameters || {});
        const limit = queryParams.limit ? parseInt(queryParams.limit) : 50;
        let result;
        switch (queryParams.queryType) {
            case 'byPrincipal':
                result = await queryByPrincipal(queryParams.principalId, queryParams.startTime, queryParams.endTime, limit, queryParams.nextToken);
                break;
            case 'byService':
                result = await queryByService(queryParams.serviceName, queryParams.eventType, limit, queryParams.nextToken);
                break;
            case 'byRiskLevel':
                result = await queryByRiskLevel(queryParams.riskLevel, queryParams.startTime, queryParams.endTime, limit, queryParams.nextToken);
                break;
            case 'byTimeRange':
                result = await queryByTimeRange(queryParams.startTime, queryParams.endTime, limit, queryParams.nextToken);
                break;
            default:
                throw new Error('Invalid query type');
        }
        return {
            statusCode: 200,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*',
                'Access-Control-Allow-Methods': 'GET',
                'Access-Control-Allow-Headers': 'Content-Type,Authorization'
            },
            body: JSON.stringify(result)
        };
    }
    catch (error) {
        console.error('Query failed:', error);
        if (error instanceof zod_1.z.ZodError) {
            return {
                statusCode: 400,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    error: 'Invalid query parameters',
                    details: error.errors
                })
            };
        }
        return {
            statusCode: 500,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                error: 'Internal server error',
                message: error instanceof Error ? error.message : 'Unknown error'
            })
        };
    }
};
exports.handler = handler;
async function queryByPrincipal(principalId, startTime, endTime, limit = 50, nextToken) {
    const params = {
        TableName: process.env.AUDIT_TABLE_NAME,
        IndexName: 'PrincipalTimeIndex',
        KeyConditionExpression: 'principalId = :principalId',
        ExpressionAttributeValues: {
            ':principalId': principalId
        },
        Limit: limit,
        ScanIndexForward: false // Most recent first
    };
    // Add time range filter if provided
    if (startTime && endTime) {
        params.KeyConditionExpression += ' AND #timestamp BETWEEN :startTime AND :endTime';
        params.ExpressionAttributeNames = { '#timestamp': 'timestamp' };
        params.ExpressionAttributeValues[':startTime'] = startTime;
        params.ExpressionAttributeValues[':endTime'] = endTime;
    }
    if (nextToken) {
        params.ExclusiveStartKey = JSON.parse(Buffer.from(nextToken, 'base64').toString());
    }
    const command = new lib_dynamodb_1.QueryCommand(params);
    const response = await docClient.send(command);
    return {
        events: response.Items || [],
        nextToken: response.LastEvaluatedKey ?
            Buffer.from(JSON.stringify(response.LastEvaluatedKey)).toString('base64') :
            undefined
    };
}
async function queryByService(serviceName, eventType, limit = 50, nextToken) {
    const params = {
        TableName: process.env.AUDIT_TABLE_NAME,
        IndexName: 'ServiceEventTypeIndex',
        KeyConditionExpression: 'serviceName = :serviceName',
        ExpressionAttributeValues: {
            ':serviceName': serviceName
        },
        Limit: limit,
        ScanIndexForward: false
    };
    if (eventType) {
        params.KeyConditionExpression += ' AND eventType = :eventType';
        params.ExpressionAttributeValues[':eventType'] = eventType;
    }
    if (nextToken) {
        params.ExclusiveStartKey = JSON.parse(Buffer.from(nextToken, 'base64').toString());
    }
    const command = new lib_dynamodb_1.QueryCommand(params);
    const response = await docClient.send(command);
    return {
        events: response.Items || [],
        nextToken: response.LastEvaluatedKey ?
            Buffer.from(JSON.stringify(response.LastEvaluatedKey)).toString('base64') :
            undefined
    };
}
async function queryByRiskLevel(riskLevel, startTime, endTime, limit = 50, nextToken) {
    const params = {
        TableName: process.env.AUDIT_TABLE_NAME,
        IndexName: 'RiskLevelTimeIndex',
        KeyConditionExpression: 'riskLevel = :riskLevel',
        ExpressionAttributeValues: {
            ':riskLevel': riskLevel
        },
        Limit: limit,
        ScanIndexForward: false
    };
    if (startTime && endTime) {
        params.KeyConditionExpression += ' AND #timestamp BETWEEN :startTime AND :endTime';
        params.ExpressionAttributeNames = { '#timestamp': 'timestamp' };
        params.ExpressionAttributeValues[':startTime'] = startTime;
        params.ExpressionAttributeValues[':endTime'] = endTime;
    }
    if (nextToken) {
        params.ExclusiveStartKey = JSON.parse(Buffer.from(nextToken, 'base64').toString());
    }
    const command = new lib_dynamodb_1.QueryCommand(params);
    const response = await docClient.send(command);
    return {
        events: response.Items || [],
        nextToken: response.LastEvaluatedKey ?
            Buffer.from(JSON.stringify(response.LastEvaluatedKey)).toString('base64') :
            undefined
    };
}
async function queryByTimeRange(startTime, endTime, limit = 50, nextToken) {
    // This requires a scan operation since we don't have a GSI with just timestamp
    // In production, consider using DynamoDB Streams with time-series data patterns
    const params = {
        TableName: process.env.AUDIT_TABLE_NAME,
        FilterExpression: '#timestamp BETWEEN :startTime AND :endTime',
        ExpressionAttributeNames: {
            '#timestamp': 'timestamp'
        },
        ExpressionAttributeValues: {
            ':startTime': startTime,
            ':endTime': endTime
        },
        Limit: limit
    };
    if (nextToken) {
        params.ExclusiveStartKey = JSON.parse(Buffer.from(nextToken, 'base64').toString());
    }
    const command = new lib_dynamodb_1.ScanCommand(params);
    const response = await docClient.send(command);
    return {
        events: response.Items || [],
        nextToken: response.LastEvaluatedKey ?
            Buffer.from(JSON.stringify(response.LastEvaluatedKey)).toString('base64') :
            undefined
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9sYW1iZGEvcXVlcnkvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsOERBQTBEO0FBQzFELHdEQUEwRjtBQUUxRiw2QkFBd0I7QUFFeEIsTUFBTSxZQUFZLEdBQUcsSUFBSSxnQ0FBYyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQzVDLE1BQU0sU0FBUyxHQUFHLHFDQUFzQixDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztBQUU1RCxNQUFNLGlCQUFpQixHQUFHLE9BQUMsQ0FBQyxNQUFNLENBQUM7SUFDakMsU0FBUyxFQUFFLE9BQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxhQUFhLEVBQUUsV0FBVyxFQUFFLGFBQWEsRUFBRSxhQUFhLENBQUMsQ0FBQztJQUM3RSxXQUFXLEVBQUUsT0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLFFBQVEsRUFBRTtJQUNsQyxXQUFXLEVBQUUsT0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLFFBQVEsRUFBRTtJQUNsQyxTQUFTLEVBQUUsT0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLFFBQVEsRUFBRTtJQUNoQyxTQUFTLEVBQUUsT0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLFVBQVUsQ0FBQyxDQUFDLENBQUMsUUFBUSxFQUFFO0lBQ25FLFNBQVMsRUFBRSxPQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsUUFBUSxFQUFFO0lBQ2hDLE9BQU8sRUFBRSxPQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsUUFBUSxFQUFFO0lBQzlCLEtBQUssRUFBRSxPQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsUUFBUSxFQUFFO0lBQzVCLFNBQVMsRUFBRSxPQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsUUFBUSxFQUFFO0NBQ2pDLENBQUMsQ0FBQztBQVFJLE1BQU0sT0FBTyxHQUF5RCxLQUFLLEVBQ2hG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QyxDQUFDO0lBQ3hDLE1BQU0sUUFBUSxHQUFHLE1BQU0sU0FBUyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUUvQyxPQUFPO1FBQ0wsTUFBTSxFQUFFLFFBQVEsQ0FBQyxLQUFLLElBQUksRUFBRTtRQUM1QixTQUFTLEVBQUUsUUFBUSxDQUFDLGdCQUFnQixDQUFDLENBQUM7WUFDcEMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7WUFDM0UsU0FBUztLQUNaLENBQUM7QUFDSixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRHluYW1vREJDbGllbnQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtZHluYW1vZGInO1xuaW1wb3J0IHsgRHluYW1vREJEb2N1bWVudENsaWVudCwgUXVlcnlDb21tYW5kLCBTY2FuQ29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2xpYi1keW5hbW9kYic7XG5pbXBvcnQgeyBBUElHYXRld2F5UHJveHlFdmVudCwgQVBJR2F0ZXdheVByb3h5UmVzdWx0LCBDb250ZXh0LCBIYW5kbGVyIH0gZnJvbSAnYXdzLWxhbWJkYSc7XG5pbXBvcnQgeyB6IH0gZnJvbSAnem9kJztcblxuY29uc3QgZHluYW1vQ2xpZW50ID0gbmV3IER5bmFtb0RCQ2xpZW50KHt9KTtcbmNvbnN0IGRvY0NsaWVudCA9IER5bmFtb0RCRG9jdW1lbnRDbGllbnQuZnJvbShkeW5hbW9DbGllbnQpO1xuXG5jb25zdCBRdWVyeVBhcmFtc1NjaGVtYSA9IHoub2JqZWN0KHtcbiAgcXVlcnlUeXBlOiB6LmVudW0oWydieVByaW5jaXBhbCcsICdieVNlcnZpY2UnLCAnYnlSaXNrTGV2ZWwnLCAnYnlUaW1lUmFuZ2UnXSksXG4gIHByaW5jaXBhbElkOiB6LnN0cmluZygpLm9wdGlvbmFsKCksXG4gIHNlcnZpY2VOYW1lOiB6LnN0cmluZygpLm9wdGlvbmFsKCksXG4gIGV2ZW50VHlwZTogei5zdHJpbmcoKS5vcHRpb25hbCgpLFxuICByaXNrTGV2ZWw6IHouZW51bShbJ0xPVycsICdNRURJVU0nLCAnSElHSCcsICdDUklUSUNBTCddKS5vcHRpb25hbCgpLFxuICBzdGFydFRpbWU6IHouc3RyaW5nKCkub3B0aW9uYWwoKSxcbiAgZW5kVGltZTogei5zdHJpbmcoKS5vcHRpb25hbCgpLFxuICBsaW1pdDogei5zdHJpbmcoKS5vcHRpb25hbCgpLFxuICBuZXh0VG9rZW46IHouc3RyaW5nKCkub3B0aW9uYWwoKVxufSk7XG5cbmludGVyZmFjZSBBdWRpdFF1ZXJ5UmVzdWx0IHtcbiAgZXZlbnRzOiBhbnlbXTtcbiAgbmV4dFRva2VuPzogc3RyaW5nO1xuICB0b3RhbENvdW50PzogbnVtYmVyO1xufVxuXG5leHBvcnQgY29uc3QgaGFuZGxlcjogSGFuZGxlcjxBUElHYXRld2F5UHJveHlFdmVudCwgQVBJR2F0ZXdheVByb3h5UmVzdWx0PiA9IGFzeW5jIChcbiAgZXZlbnQ6IEFQSUdhdGV3YXlQcm94eUV2ZW50LFxuICBjb250ZXh0OiBDb250ZXh0XG4pOiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdD4gPT4ge1xuICBjb25zb2xlLmxvZygnUHJvY2Vzc2luZyBhdWRpdCBxdWVyeTonLCBKU09OLnN0cmluZ2lmeShldmVudC5xdWVyeVN0cmluZ1BhcmFtZXRlcnMsIG51bGwsIDIpKTtcbiAgXG4gIHRyeSB7XG4gICAgLy8gUGFyc2UgYW5kIHZhbGlkYXRlIHF1ZXJ5IHBhcmFtZXRlcnNcbiAgICBjb25zdCBxdWVyeVBhcmFtcyA9IFF1ZXJ5UGFyYW1zU2NoZW1hLnBhcnNlKGV2ZW50LnF1ZXJ5U3RyaW5nUGFyYW1ldGVycyB8fCB7fSk7XG4gICAgY29uc3QgbGltaXQgPSBxdWVyeVBhcmFtcy5saW1pdCA/IHBhcnNlSW50KHF1ZXJ5UGFyYW1zLmxpbWl0KSA6IDUwO1xuICAgIFxuICAgIGxldCByZXN1bHQ6IEF1ZGl0UXVlcnlSZXN1bHQ7XG4gICAgXG4gICAgc3dpdGNoIChxdWVyeVBhcmFtcy5xdWVyeVR5cGUpIHtcbiAgICAgIGNhc2UgJ2J5UHJpbmNpcGFsJzpcbiAgICAgICAgcmVzdWx0ID0gYXdhaXQgcXVlcnlCeVByaW5jaXBhbChxdWVyeVBhcmFtcy5wcmluY2lwYWxJZCEsIHF1ZXJ5UGFyYW1zLnN0YXJ0VGltZSwgcXVlcnlQYXJhbXMuZW5kVGltZSwgbGltaXQsIHF1ZXJ5UGFyYW1zLm5leHRUb2tlbik7XG4gICAgICAgIGJyZWFrO1xuICAgICAgICBcbiAgICAgIGNhc2UgJ2J5U2VydmljZSc6XG4gICAgICAgIHJlc3VsdCA9IGF3YWl0IHF1ZXJ5QnlTZXJ2aWNlKHF1ZXJ5UGFyYW1zLnNlcnZpY2VOYW1lISwgcXVlcnlQYXJhbXMuZXZlbnRUeXBlLCBsaW1pdCwgcXVlcnlQYXJhbXMubmV4dFRva2VuKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICAgIFxuICAgICAgY2FzZSAnYnlSaXNrTGV2ZWwnOlxuICAgICAgICByZXN1bHQgPSBhd2FpdCBxdWVyeUJ5Umlza0xldmVsKHF1ZXJ5UGFyYW1zLnJpc2tMZXZlbCEsIHF1ZXJ5UGFyYW1zLnN0YXJ0VGltZSwgcXVlcnlQYXJhbXMuZW5kVGltZSwgbGltaXQsIHF1ZXJ5UGFyYW1zLm5leHRUb2tlbik7XG4gICAgICAgIGJyZWFrO1xuICAgICAgICBcbiAgICAgIGNhc2UgJ2J5VGltZVJhbmdlJzpcbiAgICAgICAgcmVzdWx0ID0gYXdhaXQgcXVlcnlCeVRpbWVSYW5nZShxdWVyeVBhcmFtcy5zdGFydFRpbWUhLCBxdWVyeVBhcmFtcy5lbmRUaW1lISwgbGltaXQsIHF1ZXJ5UGFyYW1zLm5leHRUb2tlbik7XG4gICAgICAgIGJyZWFrO1xuICAgICAgICBcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBxdWVyeSB0eXBlJyk7XG4gICAgfVxuICAgIFxuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiAyMDAsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnKicsXG4gICAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1NZXRob2RzJzogJ0dFVCcsXG4gICAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1IZWFkZXJzJzogJ0NvbnRlbnQtVHlwZSxBdXRob3JpemF0aW9uJ1xuICAgICAgfSxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHJlc3VsdClcbiAgICB9O1xuICAgIFxuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ1F1ZXJ5IGZhaWxlZDonLCBlcnJvcik7XG4gICAgXG4gICAgaWYgKGVycm9yIGluc3RhbmNlb2Ygei5ab2RFcnJvcikge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3RhdHVzQ29kZTogNDAwLFxuICAgICAgICBoZWFkZXJzOiB7ICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicgfSxcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgIGVycm9yOiAnSW52YWxpZCBxdWVyeSBwYXJhbWV0ZXJzJyxcbiAgICAgICAgICBkZXRhaWxzOiBlcnJvci5lcnJvcnNcbiAgICAgICAgfSlcbiAgICAgIH07XG4gICAgfVxuICAgIFxuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiA1MDAsXG4gICAgICBoZWFkZXJzOiB7ICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicgfSxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgZXJyb3I6ICdJbnRlcm5hbCBzZXJ2ZXIgZXJyb3InLFxuICAgICAgICBtZXNzYWdlOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJ1xuICAgICAgfSlcbiAgICB9O1xuICB9XG59O1xuXG5hc3luYyBmdW5jdGlvbiBxdWVyeUJ5UHJpbmNpcGFsKFxuICBwcmluY2lwYWxJZDogc3RyaW5nLFxuICBzdGFydFRpbWU/OiBzdHJpbmcsXG4gIGVuZFRpbWU/OiBzdHJpbmcsXG4gIGxpbWl0OiBudW1iZXIgPSA1MCxcbiAgbmV4dFRva2VuPzogc3RyaW5nXG4pOiBQcm9taXNlPEF1ZGl0UXVlcnlSZXN1bHQ+IHtcbiAgY29uc3QgcGFyYW1zOiBhbnkgPSB7XG4gICAgVGFibGVOYW1lOiBwcm9jZXNzLmVudi5BVURJVF9UQUJMRV9OQU1FISxcbiAgICBJbmRleE5hbWU6ICdQcmluY2lwYWxUaW1lSW5kZXgnLFxuICAgIEtleUNvbmRpdGlvbkV4cHJlc3Npb246ICdwcmluY2lwYWxJZCA9IDpwcmluY2lwYWxJZCcsXG4gICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xuICAgICAgJzpwcmluY2lwYWxJZCc6IHByaW5jaXBhbElkXG4gICAgfSxcbiAgICBMaW1pdDogbGltaXQsXG4gICAgU2NhbkluZGV4Rm9yd2FyZDogZmFsc2UgLy8gTW9zdCByZWNlbnQgZmlyc3RcbiAgfTtcbiAgXG4gIC8vIEFkZCB0aW1lIHJhbmdlIGZpbHRlciBpZiBwcm92aWRlZFxuICBpZiAoc3RhcnRUaW1lICYmIGVuZFRpbWUpIHtcbiAgICBwYXJhbXMuS2V5Q29uZGl0aW9uRXhwcmVzc2lvbiArPSAnIEFORCAjdGltZXN0YW1wIEJFVFdFRU4gOnN0YXJ0VGltZSBBTkQgOmVuZFRpbWUnO1xuICAgIHBhcmFtcy5FeHByZXNzaW9uQXR0cmlidXRlTmFtZXMgPSB7ICcjdGltZXN0YW1wJzogJ3RpbWVzdGFtcCcgfTtcbiAgICBwYXJhbXMuRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlc1snOnN0YXJ0VGltZSddID0gc3RhcnRUaW1lO1xuICAgIHBhcmFtcy5FeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzWyc6ZW5kVGltZSddID0gZW5kVGltZTtcbiAgfVxuICBcbiAgaWYgKG5leHRUb2tlbikge1xuICAgIHBhcmFtcy5FeGNsdXNpdmVTdGFydEtleSA9IEpTT04ucGFyc2UoQnVmZmVyLmZyb20obmV4dFRva2VuLCAnYmFzZTY0JykudG9TdHJpbmcoKSk7XG4gIH1cbiAgXG4gIGNvbnN0IGNvbW1hbmQgPSBuZXcgUXVlcnlDb21tYW5kKHBhcmFtcyk7XG4gIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZG9jQ2xpZW50LnNlbmQoY29tbWFuZCk7XG4gIFxuICByZXR1cm4ge1xuICAgIGV2ZW50czogcmVzcG9uc2UuSXRlbXMgfHwgW10sXG4gICAgbmV4dFRva2VuOiByZXNwb25zZS5MYXN0RXZhbHVhdGVkS2V5ID8gXG4gICAgICBCdWZmZXIuZnJvbShKU09OLnN0cmluZ2lmeShyZXNwb25zZS5MYXN0RXZhbHVhdGVkS2V5KSkudG9TdHJpbmcoJ2Jhc2U2NCcpIDogXG4gICAgICB1bmRlZmluZWRcbiAgfTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gcXVlcnlCeVNlcnZpY2UoXG4gIHNlcnZpY2VOYW1lOiBzdHJpbmcsXG4gIGV2ZW50VHlwZT86IHN0cmluZyxcbiAgbGltaXQ6IG51bWJlciA9IDUwLFxuICBuZXh0VG9rZW4/OiBzdHJpbmdcbik6IFByb21pc2U8QXVkaXRRdWVyeVJlc3VsdD4ge1xuICBjb25zdCBwYXJhbXM6IGFueSA9IHtcbiAgICBUYWJsZU5hbWU6IHByb2Nlc3MuZW52LkFVRElUX1RBQkxFX05BTUUhLFxuICAgIEluZGV4TmFtZTogJ1NlcnZpY2VFdmVudFR5cGVJbmRleCcsXG4gICAgS2V5Q29uZGl0aW9uRXhwcmVzc2lvbjogJ3NlcnZpY2VOYW1lID0gOnNlcnZpY2VOYW1lJyxcbiAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAnOnNlcnZpY2VOYW1lJzogc2VydmljZU5hbWVcbiAgICB9LFxuICAgIExpbWl0OiBsaW1pdCxcbiAgICBTY2FuSW5kZXhGb3J3YXJkOiBmYWxzZVxuICB9O1xuICBcbiAgaWYgKGV2ZW50VHlwZSkge1xuICAgIHBhcmFtcy5LZXlDb25kaXRpb25FeHByZXNzaW9uICs9ICcgQU5EIGV2ZW50VHlwZSA9IDpldmVudFR5cGUnO1xuICAgIHBhcmFtcy5FeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzWyc6ZXZlbnRUeXBlJ10gPSBldmVudFR5cGU7XG4gIH1cbiAgXG4gIGlmIChuZXh0VG9rZW4pIHtcbiAgICBwYXJhbXMuRXhjbHVzaXZlU3RhcnRLZXkgPSBKU09OLnBhcnNlKEJ1ZmZlci5mcm9tKG5leHRUb2tlbiwgJ2Jhc2U2NCcpLnRvU3RyaW5nKCkpO1xuICB9XG4gIFxuICBjb25zdCBjb21tYW5kID0gbmV3IFF1ZXJ5Q29tbWFuZChwYXJhbXMpO1xuICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKGNvbW1hbmQpO1xuICBcbiAgcmV0dXJuIHtcbiAgICBldmVudHM6IHJlc3BvbnNlLkl0ZW1zIHx8IFtdLFxuICAgIG5leHRUb2tlbjogcmVzcG9uc2UuTGFzdEV2YWx1YXRlZEtleSA/IFxuICAgICAgQnVmZmVyLmZyb20oSlNPTi5zdHJpbmdpZnkocmVzcG9uc2UuTGFzdEV2YWx1YXRlZEtleSkpLnRvU3RyaW5nKCdiYXNlNjQnKSA6IFxuICAgICAgdW5kZWZpbmVkXG4gIH07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHF1ZXJ5QnlSaXNrTGV2ZWwoXG4gIHJpc2tMZXZlbDogc3RyaW5nLFxuICBzdGFydFRpbWU/OiBzdHJpbmcsXG4gIGVuZFRpbWU/OiBzdHJpbmcsXG4gIGxpbWl0OiBudW1iZXIgPSA1MCxcbiAgbmV4dFRva2VuPzogc3RyaW5nXG4pOiBQcm9taXNlPEF1ZGl0UXVlcnlSZXN1bHQ+IHtcbiAgY29uc3QgcGFyYW1zOiBhbnkgPSB7XG4gICAgVGFibGVOYW1lOiBwcm9jZXNzLmVudi5BVURJVF9UQUJMRV9OQU1FISxcbiAgICBJbmRleE5hbWU6ICdSaXNrTGV2ZWxUaW1lSW5kZXgnLFxuICAgIEtleUNvbmRpdGlvbkV4cHJlc3Npb246ICdyaXNrTGV2ZWwgPSA6cmlza0xldmVsJyxcbiAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAnOnJpc2tMZXZlbCc6IHJpc2tMZXZlbFxuICAgIH0sXG4gICAgTGltaXQ6IGxpbWl0LFxuICAgIFNjYW5JbmRleEZvcndhcmQ6IGZhbHNlXG4gIH07XG4gIFxuICBpZiAoc3RhcnRUaW1lICYmIGVuZFRpbWUpIHtcbiAgICBwYXJhbXMuS2V5Q29uZGl0aW9uRXhwcmVzc2lvbiArPSAnIEFORCAjdGltZXN0YW1wIEJFVFdFRU4gOnN0YXJ0VGltZSBBTkQgOmVuZFRpbWUnO1xuICAgIHBhcmFtcy5FeHByZXNzaW9uQXR0cmlidXRlTmFtZXMgPSB7ICcjdGltZXN0YW1wJzogJ3RpbWVzdGFtcCcgfTtcbiAgICBwYXJhbXMuRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlc1snOnN0YXJ0VGltZSddID0gc3RhcnRUaW1lO1xuICAgIHBhcmFtcy5FeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzWyc6ZW5kVGltZSddID0gZW5kVGltZTtcbiAgfVxuICBcbiAgaWYgKG5leHRUb2tlbikge1xuICAgIHBhcmFtcy5FeGNsdXNpdmVTdGFydEtleSA9IEpTT04ucGFyc2UoQnVmZmVyLmZyb20obmV4dFRva2VuLCAnYmFzZTY0JykudG9TdHJpbmcoKSk7XG4gIH1cbiAgXG4gIGNvbnN0IGNvbW1hbmQgPSBuZXcgUXVlcnlDb21tYW5kKHBhcmFtcyk7XG4gIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZG9jQ2xpZW50LnNlbmQoY29tbWFuZCk7XG4gIFxuICByZXR1cm4ge1xuICAgIGV2ZW50czogcmVzcG9uc2UuSXRlbXMgfHwgW10sXG4gICAgbmV4dFRva2VuOiByZXNwb25zZS5MYXN0RXZhbHVhdGVkS2V5ID8gXG4gICAgICBCdWZmZXIuZnJvbShKU09OLnN0cmluZ2lmeShyZXNwb25zZS5MYXN0RXZhbHVhdGVkS2V5KSkudG9TdHJpbmcoJ2Jhc2U2NCcpIDogXG4gICAgICB1bmRlZmluZWRcbiAgfTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gcXVlcnlCeVRpbWVSYW5nZShcbiAgc3RhcnRUaW1lOiBzdHJpbmcsXG4gIGVuZFRpbWU6IHN0cmluZyxcbiAgbGltaXQ6IG51bWJlciA9IDUwLFxuICBuZXh0VG9rZW4/OiBzdHJpbmdcbik6IFByb21pc2U8QXVkaXRRdWVyeVJlc3VsdD4ge1xuICAvLyBUaGlzIHJlcXVpcmVzIGEgc2NhbiBvcGVyYXRpb24gc2luY2Ugd2UgZG9uJ3QgaGF2ZSBhIEdTSSB3aXRoIGp1c3QgdGltZXN0YW1wXG4gIC8vIEluIHByb2R1Y3Rpb24sIGNvbnNpZGVyIHVzaW5nIER5bmFtb0RCIFN0cmVhbXMgd2l0aCB0aW1lLXNlcmllcyBkYXRhIHBhdHRlcm5zXG4gIGNvbnN0IHBhcmFtczogYW55ID0ge1xuICAgIFRhYmxlTmFtZTogcHJvY2Vzcy5lbnYuQVVESVRfVEFCTEVfTkFNRSEsXG4gICAgRmlsdGVyRXhwcmVzc2lvbjogJyN0aW1lc3RhbXAgQkVUV0VFTiA6c3RhcnRUaW1lIEFORCA6ZW5kVGltZScsXG4gICAgRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiB7XG4gICAgICAnI3RpbWVzdGFtcCc6ICd0aW1lc3RhbXAnXG4gICAgfSxcbiAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAnOnN0YXJ0VGltZSc6IHN0YXJ0VGltZSxcbiAgICAgICc6ZW5kVGltZSc6IGVuZFRpbWVcbiAgICB9LFxuICAgIExpbWl0OiBsaW1pdFxuICB9O1xuICBcbiAgaWYgKG5leHRUb2tlbikge1xuICAgIHBhcmFtcy5FeGNsdXNpdmVTdGFydEtleSA9IEpTT04ucGFyc2UoQnVmZmVyLmZyb20obmV4dFRva2VuLCAnYmFzZTY0JykudG9TdHJpbmcoKSk7XG4gIH1cbiAgXG4gIGNvbnN0IGNvbW1hbmQgPSBuZXcgU2NhbkNvbW1hbmQocGFyYW1zKTtcbiAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChjb21tYW5kKTtcbiAgXG4gIHJldHVybiB7XG4gICAgZXZlbnRzOiByZXNwb25zZS5JdGVtcyB8fCBbXSxcbiAgICBuZXh0VG9rZW46IHJlc3BvbnNlLkxhc3RFdmFsdWF0ZWRLZXkgPyBcbiAgICAgIEJ1ZmZlci5mcm9tKEpTT04uc3RyaW5naWZ5KHJlc3BvbnNlLkxhc3RFdmFsdWF0ZWRLZXkpKS50b1N0cmluZygnYmFzZTY0JykgOiBcbiAgICAgIHVuZGVmaW5lZFxuICB9O1xufSJdfQ==