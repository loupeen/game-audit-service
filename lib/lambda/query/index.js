"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const zod_1 = require("zod");
const dynamoClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(dynamoClient);
const QueryParamsSchema = zod_1.z.object({
    queryType: zod_1.z.enum(['byPrincipal', 'byService', 'byRiskLevel', 'byTimeRange']),
    principalId: zod_1.z.string().optional(),
    serviceName: zod_1.z.string().optional(),
    eventType: zod_1.z.string().optional(),
    riskLevel: zod_1.z.enum(['LOW', 'MEDIUM', 'HIGH', 'CRITICAL']).optional(),
    startTime: zod_1.z.string().optional(),
    endTime: zod_1.z.string().optional(),
    limit: zod_1.z.string().optional(),
    nextToken: zod_1.z.string().optional()
});
const handler = async (event, _context) => {
    console.log('Processing audit query:', JSON.stringify(event.queryStringParameters, null, 2));
    try {
        // Parse and validate query parameters
        const queryParams = QueryParamsSchema.parse(event.queryStringParameters || {});
        const limit = queryParams.limit ? parseInt(queryParams.limit) : 50;
        let result;
        switch (queryParams.queryType) {
            case 'byPrincipal':
                result = await queryByPrincipal(queryParams.principalId, queryParams.startTime, queryParams.endTime, limit, queryParams.nextToken);
                break;
            case 'byService':
                result = await queryByService(queryParams.serviceName, queryParams.eventType, limit, queryParams.nextToken);
                break;
            case 'byRiskLevel':
                result = await queryByRiskLevel(queryParams.riskLevel, queryParams.startTime, queryParams.endTime, limit, queryParams.nextToken);
                break;
            case 'byTimeRange':
                result = await queryByTimeRange(queryParams.startTime, queryParams.endTime, limit, queryParams.nextToken);
                break;
            default:
                throw new Error('Invalid query type');
        }
        return {
            statusCode: 200,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*',
                'Access-Control-Allow-Methods': 'GET',
                'Access-Control-Allow-Headers': 'Content-Type,Authorization'
            },
            body: JSON.stringify(result)
        };
    }
    catch (error) {
        console.error('Query failed:', error);
        if (error instanceof zod_1.z.ZodError) {
            return {
                statusCode: 400,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    error: 'Invalid query parameters',
                    details: error.errors
                })
            };
        }
        return {
            statusCode: 500,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                error: 'Internal server error',
                message: error instanceof Error ? error.message : 'Unknown error'
            })
        };
    }
};
exports.handler = handler;
async function queryByPrincipal(principalId, startTime, endTime, limit = 50, nextToken) {
    const params = {
        TableName: process.env.AUDIT_TABLE_NAME,
        IndexName: 'PrincipalTimeIndex',
        KeyConditionExpression: 'principalId = :principalId',
        ExpressionAttributeValues: {
            ':principalId': principalId
        },
        Limit: limit,
        ScanIndexForward: false // Most recent first
    };
    // Add time range filter if provided
    if (startTime && endTime) {
        params.KeyConditionExpression += ' AND #timestamp BETWEEN :startTime AND :endTime';
        params.ExpressionAttributeNames = { '#timestamp': 'timestamp' };
        params.ExpressionAttributeValues[':startTime'] = startTime;
        params.ExpressionAttributeValues[':endTime'] = endTime;
    }
    if (nextToken) {
        params.ExclusiveStartKey = JSON.parse(Buffer.from(nextToken, 'base64').toString());
    }
    const command = new lib_dynamodb_1.QueryCommand(params);
    const response = await docClient.send(command);
    return {
        events: response.Items || [],
        nextToken: response.LastEvaluatedKey ?
            Buffer.from(JSON.stringify(response.LastEvaluatedKey)).toString('base64') :
            undefined
    };
}
async function queryByService(serviceName, eventType, limit = 50, nextToken) {
    const params = {
        TableName: process.env.AUDIT_TABLE_NAME,
        IndexName: 'ServiceEventTypeIndex',
        KeyConditionExpression: 'serviceName = :serviceName',
        ExpressionAttributeValues: {
            ':serviceName': serviceName
        },
        Limit: limit,
        ScanIndexForward: false
    };
    if (eventType) {
        params.KeyConditionExpression += ' AND eventType = :eventType';
        params.ExpressionAttributeValues[':eventType'] = eventType;
    }
    if (nextToken) {
        params.ExclusiveStartKey = JSON.parse(Buffer.from(nextToken, 'base64').toString());
    }
    const command = new lib_dynamodb_1.QueryCommand(params);
    const response = await docClient.send(command);
    return {
        events: response.Items || [],
        nextToken: response.LastEvaluatedKey ?
            Buffer.from(JSON.stringify(response.LastEvaluatedKey)).toString('base64') :
            undefined
    };
}
async function queryByRiskLevel(riskLevel, startTime, endTime, limit = 50, nextToken) {
    const params = {
        TableName: process.env.AUDIT_TABLE_NAME,
        IndexName: 'RiskLevelTimeIndex',
        KeyConditionExpression: 'riskLevel = :riskLevel',
        ExpressionAttributeValues: {
            ':riskLevel': riskLevel
        },
        Limit: limit,
        ScanIndexForward: false
    };
    if (startTime && endTime) {
        params.KeyConditionExpression += ' AND #timestamp BETWEEN :startTime AND :endTime';
        params.ExpressionAttributeNames = { '#timestamp': 'timestamp' };
        params.ExpressionAttributeValues[':startTime'] = startTime;
        params.ExpressionAttributeValues[':endTime'] = endTime;
    }
    if (nextToken) {
        params.ExclusiveStartKey = JSON.parse(Buffer.from(nextToken, 'base64').toString());
    }
    const command = new lib_dynamodb_1.QueryCommand(params);
    const response = await docClient.send(command);
    return {
        events: response.Items || [],
        nextToken: response.LastEvaluatedKey ?
            Buffer.from(JSON.stringify(response.LastEvaluatedKey)).toString('base64') :
            undefined
    };
}
async function queryByTimeRange(startTime, endTime, limit = 50, nextToken) {
    // This requires a scan operation since we don't have a GSI with just timestamp
    // In production, consider using DynamoDB Streams with time-series data patterns
    const params = {
        TableName: process.env.AUDIT_TABLE_NAME,
        FilterExpression: '#timestamp BETWEEN :startTime AND :endTime',
        ExpressionAttributeNames: {
            '#timestamp': 'timestamp'
        },
        ExpressionAttributeValues: {
            ':startTime': startTime,
            ':endTime': endTime
        },
        Limit: limit
    };
    if (nextToken) {
        params.ExclusiveStartKey = JSON.parse(Buffer.from(nextToken, 'base64').toString());
    }
    const command = new lib_dynamodb_1.ScanCommand(params);
    const response = await docClient.send(command);
    return {
        events: response.Items || [],
        nextToken: response.LastEvaluatedKey ?
            Buffer.from(JSON.stringify(response.LastEvaluatedKey)).toString('base64') :
            undefined
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9sYW1iZGEvcXVlcnkvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsOERBQTBEO0FBQzFELHdEQUEwRjtBQUUxRiw2QkFBd0I7QUFFeEIsTUFBTSxZQUFZLEdBQUcsSUFBSSxnQ0FBYyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQzVDLE1BQU0sU0FBUyxHQUFHLHFDQUFzQixDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztBQUU1RCxNQUFNLGlCQUFpQixHQUFHLE9BQUMsQ0FBQyxNQUFNLENBQUM7SUFDakMsU0FBUyxFQUFFLE9BQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxhQUFhLEVBQUUsV0FBVyxFQUFFLGFBQWEsRUFBRSxhQUFhLENBQUMsQ0FBQztJQUM3RSxXQUFXLEVBQUUsT0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLFFBQVEsRUFBRTtJQUNsQyxXQUFXLEVBQUUsT0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLFFBQVEsRUFBRTtJQUNsQyxTQUFTLEVBQUUsT0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLFFBQVEsRUFBRTtJQUNoQyxTQUFTLEVBQUUsT0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLFVBQVUsQ0FBQyxDQUFDLENBQUMsUUFBUSxFQUFFO0lBQ25FLFNBQVMsRUFBRSxPQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsUUFBUSxFQUFFO0lBQ2hDLE9BQU8sRUFBRSxPQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsUUFBUSxFQUFFO0lBQzlCLEtBQUssRUFBRSxPQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsUUFBUSxFQUFFO0lBQzVCLFNBQVMsRUFBRSxPQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsUUFBUSxFQUFFO0NBQ2pDLENBQUMsQ0FBQztBQVFJLE1BQU0sT0FBTyxHQUF5RCxLQUFLLEVBQ2hG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LENBQUM7SUFDeEMsTUFBTSxRQUFRLEdBQUcsTUFBTSxTQUFTLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBRS9DLE9BQU87UUFDTCxNQUFNLEVBQUUsUUFBUSxDQUFDLEtBQUssSUFBSSxFQUFFO1FBQzVCLFNBQVMsRUFBRSxRQUFRLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztZQUNwQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLGdCQUFnQixDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztZQUMzRSxTQUFTO0tBQ1osQ0FBQztBQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEeW5hbW9EQkNsaWVudCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1keW5hbW9kYic7XG5pbXBvcnQgeyBEeW5hbW9EQkRvY3VtZW50Q2xpZW50LCBRdWVyeUNvbW1hbmQsIFNjYW5Db21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvbGliLWR5bmFtb2RiJztcbmltcG9ydCB7IEFQSUdhdGV3YXlQcm94eUV2ZW50LCBBUElHYXRld2F5UHJveHlSZXN1bHQsIENvbnRleHQsIEhhbmRsZXIgfSBmcm9tICdhd3MtbGFtYmRhJztcbmltcG9ydCB7IHogfSBmcm9tICd6b2QnO1xuXG5jb25zdCBkeW5hbW9DbGllbnQgPSBuZXcgRHluYW1vREJDbGllbnQoe30pO1xuY29uc3QgZG9jQ2xpZW50ID0gRHluYW1vREJEb2N1bWVudENsaWVudC5mcm9tKGR5bmFtb0NsaWVudCk7XG5cbmNvbnN0IFF1ZXJ5UGFyYW1zU2NoZW1hID0gei5vYmplY3Qoe1xuICBxdWVyeVR5cGU6IHouZW51bShbJ2J5UHJpbmNpcGFsJywgJ2J5U2VydmljZScsICdieVJpc2tMZXZlbCcsICdieVRpbWVSYW5nZSddKSxcbiAgcHJpbmNpcGFsSWQ6IHouc3RyaW5nKCkub3B0aW9uYWwoKSxcbiAgc2VydmljZU5hbWU6IHouc3RyaW5nKCkub3B0aW9uYWwoKSxcbiAgZXZlbnRUeXBlOiB6LnN0cmluZygpLm9wdGlvbmFsKCksXG4gIHJpc2tMZXZlbDogei5lbnVtKFsnTE9XJywgJ01FRElVTScsICdISUdIJywgJ0NSSVRJQ0FMJ10pLm9wdGlvbmFsKCksXG4gIHN0YXJ0VGltZTogei5zdHJpbmcoKS5vcHRpb25hbCgpLFxuICBlbmRUaW1lOiB6LnN0cmluZygpLm9wdGlvbmFsKCksXG4gIGxpbWl0OiB6LnN0cmluZygpLm9wdGlvbmFsKCksXG4gIG5leHRUb2tlbjogei5zdHJpbmcoKS5vcHRpb25hbCgpXG59KTtcblxuaW50ZXJmYWNlIEF1ZGl0UXVlcnlSZXN1bHQge1xuICBldmVudHM6IGFueVtdO1xuICBuZXh0VG9rZW4/OiBzdHJpbmc7XG4gIHRvdGFsQ291bnQ/OiBudW1iZXI7XG59XG5cbmV4cG9ydCBjb25zdCBoYW5kbGVyOiBIYW5kbGVyPEFQSUdhdGV3YXlQcm94eUV2ZW50LCBBUElHYXRld2F5UHJveHlSZXN1bHQ+ID0gYXN5bmMgKFxuICBldmVudDogQVBJR2F0ZXdheVByb3h5RXZlbnQsXG4gIF9jb250ZXh0OiBDb250ZXh0XG4pOiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdD4gPT4ge1xuICBjb25zb2xlLmxvZygnUHJvY2Vzc2luZyBhdWRpdCBxdWVyeTonLCBKU09OLnN0cmluZ2lmeShldmVudC5xdWVyeVN0cmluZ1BhcmFtZXRlcnMsIG51bGwsIDIpKTtcbiAgXG4gIHRyeSB7XG4gICAgLy8gUGFyc2UgYW5kIHZhbGlkYXRlIHF1ZXJ5IHBhcmFtZXRlcnNcbiAgICBjb25zdCBxdWVyeVBhcmFtcyA9IFF1ZXJ5UGFyYW1zU2NoZW1hLnBhcnNlKGV2ZW50LnF1ZXJ5U3RyaW5nUGFyYW1ldGVycyB8fCB7fSk7XG4gICAgY29uc3QgbGltaXQgPSBxdWVyeVBhcmFtcy5saW1pdCA/IHBhcnNlSW50KHF1ZXJ5UGFyYW1zLmxpbWl0KSA6IDUwO1xuICAgIFxuICAgIGxldCByZXN1bHQ6IEF1ZGl0UXVlcnlSZXN1bHQ7XG4gICAgXG4gICAgc3dpdGNoIChxdWVyeVBhcmFtcy5xdWVyeVR5cGUpIHtcbiAgICAgIGNhc2UgJ2J5UHJpbmNpcGFsJzpcbiAgICAgICAgcmVzdWx0ID0gYXdhaXQgcXVlcnlCeVByaW5jaXBhbChxdWVyeVBhcmFtcy5wcmluY2lwYWxJZCEsIHF1ZXJ5UGFyYW1zLnN0YXJ0VGltZSwgcXVlcnlQYXJhbXMuZW5kVGltZSwgbGltaXQsIHF1ZXJ5UGFyYW1zLm5leHRUb2tlbik7XG4gICAgICAgIGJyZWFrO1xuICAgICAgICBcbiAgICAgIGNhc2UgJ2J5U2VydmljZSc6XG4gICAgICAgIHJlc3VsdCA9IGF3YWl0IHF1ZXJ5QnlTZXJ2aWNlKHF1ZXJ5UGFyYW1zLnNlcnZpY2VOYW1lISwgcXVlcnlQYXJhbXMuZXZlbnRUeXBlLCBsaW1pdCwgcXVlcnlQYXJhbXMubmV4dFRva2VuKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICAgIFxuICAgICAgY2FzZSAnYnlSaXNrTGV2ZWwnOlxuICAgICAgICByZXN1bHQgPSBhd2FpdCBxdWVyeUJ5Umlza0xldmVsKHF1ZXJ5UGFyYW1zLnJpc2tMZXZlbCEsIHF1ZXJ5UGFyYW1zLnN0YXJ0VGltZSwgcXVlcnlQYXJhbXMuZW5kVGltZSwgbGltaXQsIHF1ZXJ5UGFyYW1zLm5leHRUb2tlbik7XG4gICAgICAgIGJyZWFrO1xuICAgICAgICBcbiAgICAgIGNhc2UgJ2J5VGltZVJhbmdlJzpcbiAgICAgICAgcmVzdWx0ID0gYXdhaXQgcXVlcnlCeVRpbWVSYW5nZShxdWVyeVBhcmFtcy5zdGFydFRpbWUhLCBxdWVyeVBhcmFtcy5lbmRUaW1lISwgbGltaXQsIHF1ZXJ5UGFyYW1zLm5leHRUb2tlbik7XG4gICAgICAgIGJyZWFrO1xuICAgICAgICBcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBxdWVyeSB0eXBlJyk7XG4gICAgfVxuICAgIFxuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiAyMDAsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnKicsXG4gICAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1NZXRob2RzJzogJ0dFVCcsXG4gICAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1IZWFkZXJzJzogJ0NvbnRlbnQtVHlwZSxBdXRob3JpemF0aW9uJ1xuICAgICAgfSxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHJlc3VsdClcbiAgICB9O1xuICAgIFxuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ1F1ZXJ5IGZhaWxlZDonLCBlcnJvcik7XG4gICAgXG4gICAgaWYgKGVycm9yIGluc3RhbmNlb2Ygei5ab2RFcnJvcikge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3RhdHVzQ29kZTogNDAwLFxuICAgICAgICBoZWFkZXJzOiB7ICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicgfSxcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgIGVycm9yOiAnSW52YWxpZCBxdWVyeSBwYXJhbWV0ZXJzJyxcbiAgICAgICAgICBkZXRhaWxzOiBlcnJvci5lcnJvcnNcbiAgICAgICAgfSlcbiAgICAgIH07XG4gICAgfVxuICAgIFxuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiA1MDAsXG4gICAgICBoZWFkZXJzOiB7ICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicgfSxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgZXJyb3I6ICdJbnRlcm5hbCBzZXJ2ZXIgZXJyb3InLFxuICAgICAgICBtZXNzYWdlOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJ1xuICAgICAgfSlcbiAgICB9O1xuICB9XG59O1xuXG5hc3luYyBmdW5jdGlvbiBxdWVyeUJ5UHJpbmNpcGFsKFxuICBwcmluY2lwYWxJZDogc3RyaW5nLFxuICBzdGFydFRpbWU/OiBzdHJpbmcsXG4gIGVuZFRpbWU/OiBzdHJpbmcsXG4gIGxpbWl0OiBudW1iZXIgPSA1MCxcbiAgbmV4dFRva2VuPzogc3RyaW5nXG4pOiBQcm9taXNlPEF1ZGl0UXVlcnlSZXN1bHQ+IHtcbiAgY29uc3QgcGFyYW1zOiBhbnkgPSB7XG4gICAgVGFibGVOYW1lOiBwcm9jZXNzLmVudi5BVURJVF9UQUJMRV9OQU1FISxcbiAgICBJbmRleE5hbWU6ICdQcmluY2lwYWxUaW1lSW5kZXgnLFxuICAgIEtleUNvbmRpdGlvbkV4cHJlc3Npb246ICdwcmluY2lwYWxJZCA9IDpwcmluY2lwYWxJZCcsXG4gICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xuICAgICAgJzpwcmluY2lwYWxJZCc6IHByaW5jaXBhbElkXG4gICAgfSxcbiAgICBMaW1pdDogbGltaXQsXG4gICAgU2NhbkluZGV4Rm9yd2FyZDogZmFsc2UgLy8gTW9zdCByZWNlbnQgZmlyc3RcbiAgfTtcbiAgXG4gIC8vIEFkZCB0aW1lIHJhbmdlIGZpbHRlciBpZiBwcm92aWRlZFxuICBpZiAoc3RhcnRUaW1lICYmIGVuZFRpbWUpIHtcbiAgICBwYXJhbXMuS2V5Q29uZGl0aW9uRXhwcmVzc2lvbiArPSAnIEFORCAjdGltZXN0YW1wIEJFVFdFRU4gOnN0YXJ0VGltZSBBTkQgOmVuZFRpbWUnO1xuICAgIHBhcmFtcy5FeHByZXNzaW9uQXR0cmlidXRlTmFtZXMgPSB7ICcjdGltZXN0YW1wJzogJ3RpbWVzdGFtcCcgfTtcbiAgICBwYXJhbXMuRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlc1snOnN0YXJ0VGltZSddID0gc3RhcnRUaW1lO1xuICAgIHBhcmFtcy5FeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzWyc6ZW5kVGltZSddID0gZW5kVGltZTtcbiAgfVxuICBcbiAgaWYgKG5leHRUb2tlbikge1xuICAgIHBhcmFtcy5FeGNsdXNpdmVTdGFydEtleSA9IEpTT04ucGFyc2UoQnVmZmVyLmZyb20obmV4dFRva2VuLCAnYmFzZTY0JykudG9TdHJpbmcoKSk7XG4gIH1cbiAgXG4gIGNvbnN0IGNvbW1hbmQgPSBuZXcgUXVlcnlDb21tYW5kKHBhcmFtcyk7XG4gIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZG9jQ2xpZW50LnNlbmQoY29tbWFuZCk7XG4gIFxuICByZXR1cm4ge1xuICAgIGV2ZW50czogcmVzcG9uc2UuSXRlbXMgfHwgW10sXG4gICAgbmV4dFRva2VuOiByZXNwb25zZS5MYXN0RXZhbHVhdGVkS2V5ID8gXG4gICAgICBCdWZmZXIuZnJvbShKU09OLnN0cmluZ2lmeShyZXNwb25zZS5MYXN0RXZhbHVhdGVkS2V5KSkudG9TdHJpbmcoJ2Jhc2U2NCcpIDogXG4gICAgICB1bmRlZmluZWRcbiAgfTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gcXVlcnlCeVNlcnZpY2UoXG4gIHNlcnZpY2VOYW1lOiBzdHJpbmcsXG4gIGV2ZW50VHlwZT86IHN0cmluZyxcbiAgbGltaXQ6IG51bWJlciA9IDUwLFxuICBuZXh0VG9rZW4/OiBzdHJpbmdcbik6IFByb21pc2U8QXVkaXRRdWVyeVJlc3VsdD4ge1xuICBjb25zdCBwYXJhbXM6IGFueSA9IHtcbiAgICBUYWJsZU5hbWU6IHByb2Nlc3MuZW52LkFVRElUX1RBQkxFX05BTUUhLFxuICAgIEluZGV4TmFtZTogJ1NlcnZpY2VFdmVudFR5cGVJbmRleCcsXG4gICAgS2V5Q29uZGl0aW9uRXhwcmVzc2lvbjogJ3NlcnZpY2VOYW1lID0gOnNlcnZpY2VOYW1lJyxcbiAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAnOnNlcnZpY2VOYW1lJzogc2VydmljZU5hbWVcbiAgICB9LFxuICAgIExpbWl0OiBsaW1pdCxcbiAgICBTY2FuSW5kZXhGb3J3YXJkOiBmYWxzZVxuICB9O1xuICBcbiAgaWYgKGV2ZW50VHlwZSkge1xuICAgIHBhcmFtcy5LZXlDb25kaXRpb25FeHByZXNzaW9uICs9ICcgQU5EIGV2ZW50VHlwZSA9IDpldmVudFR5cGUnO1xuICAgIHBhcmFtcy5FeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzWyc6ZXZlbnRUeXBlJ10gPSBldmVudFR5cGU7XG4gIH1cbiAgXG4gIGlmIChuZXh0VG9rZW4pIHtcbiAgICBwYXJhbXMuRXhjbHVzaXZlU3RhcnRLZXkgPSBKU09OLnBhcnNlKEJ1ZmZlci5mcm9tKG5leHRUb2tlbiwgJ2Jhc2U2NCcpLnRvU3RyaW5nKCkpO1xuICB9XG4gIFxuICBjb25zdCBjb21tYW5kID0gbmV3IFF1ZXJ5Q29tbWFuZChwYXJhbXMpO1xuICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKGNvbW1hbmQpO1xuICBcbiAgcmV0dXJuIHtcbiAgICBldmVudHM6IHJlc3BvbnNlLkl0ZW1zIHx8IFtdLFxuICAgIG5leHRUb2tlbjogcmVzcG9uc2UuTGFzdEV2YWx1YXRlZEtleSA/IFxuICAgICAgQnVmZmVyLmZyb20oSlNPTi5zdHJpbmdpZnkocmVzcG9uc2UuTGFzdEV2YWx1YXRlZEtleSkpLnRvU3RyaW5nKCdiYXNlNjQnKSA6IFxuICAgICAgdW5kZWZpbmVkXG4gIH07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHF1ZXJ5QnlSaXNrTGV2ZWwoXG4gIHJpc2tMZXZlbDogc3RyaW5nLFxuICBzdGFydFRpbWU/OiBzdHJpbmcsXG4gIGVuZFRpbWU/OiBzdHJpbmcsXG4gIGxpbWl0OiBudW1iZXIgPSA1MCxcbiAgbmV4dFRva2VuPzogc3RyaW5nXG4pOiBQcm9taXNlPEF1ZGl0UXVlcnlSZXN1bHQ+IHtcbiAgY29uc3QgcGFyYW1zOiBhbnkgPSB7XG4gICAgVGFibGVOYW1lOiBwcm9jZXNzLmVudi5BVURJVF9UQUJMRV9OQU1FISxcbiAgICBJbmRleE5hbWU6ICdSaXNrTGV2ZWxUaW1lSW5kZXgnLFxuICAgIEtleUNvbmRpdGlvbkV4cHJlc3Npb246ICdyaXNrTGV2ZWwgPSA6cmlza0xldmVsJyxcbiAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAnOnJpc2tMZXZlbCc6IHJpc2tMZXZlbFxuICAgIH0sXG4gICAgTGltaXQ6IGxpbWl0LFxuICAgIFNjYW5JbmRleEZvcndhcmQ6IGZhbHNlXG4gIH07XG4gIFxuICBpZiAoc3RhcnRUaW1lICYmIGVuZFRpbWUpIHtcbiAgICBwYXJhbXMuS2V5Q29uZGl0aW9uRXhwcmVzc2lvbiArPSAnIEFORCAjdGltZXN0YW1wIEJFVFdFRU4gOnN0YXJ0VGltZSBBTkQgOmVuZFRpbWUnO1xuICAgIHBhcmFtcy5FeHByZXNzaW9uQXR0cmlidXRlTmFtZXMgPSB7ICcjdGltZXN0YW1wJzogJ3RpbWVzdGFtcCcgfTtcbiAgICBwYXJhbXMuRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlc1snOnN0YXJ0VGltZSddID0gc3RhcnRUaW1lO1xuICAgIHBhcmFtcy5FeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzWyc6ZW5kVGltZSddID0gZW5kVGltZTtcbiAgfVxuICBcbiAgaWYgKG5leHRUb2tlbikge1xuICAgIHBhcmFtcy5FeGNsdXNpdmVTdGFydEtleSA9IEpTT04ucGFyc2UoQnVmZmVyLmZyb20obmV4dFRva2VuLCAnYmFzZTY0JykudG9TdHJpbmcoKSk7XG4gIH1cbiAgXG4gIGNvbnN0IGNvbW1hbmQgPSBuZXcgUXVlcnlDb21tYW5kKHBhcmFtcyk7XG4gIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZG9jQ2xpZW50LnNlbmQoY29tbWFuZCk7XG4gIFxuICByZXR1cm4ge1xuICAgIGV2ZW50czogcmVzcG9uc2UuSXRlbXMgfHwgW10sXG4gICAgbmV4dFRva2VuOiByZXNwb25zZS5MYXN0RXZhbHVhdGVkS2V5ID8gXG4gICAgICBCdWZmZXIuZnJvbShKU09OLnN0cmluZ2lmeShyZXNwb25zZS5MYXN0RXZhbHVhdGVkS2V5KSkudG9TdHJpbmcoJ2Jhc2U2NCcpIDogXG4gICAgICB1bmRlZmluZWRcbiAgfTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gcXVlcnlCeVRpbWVSYW5nZShcbiAgc3RhcnRUaW1lOiBzdHJpbmcsXG4gIGVuZFRpbWU6IHN0cmluZyxcbiAgbGltaXQ6IG51bWJlciA9IDUwLFxuICBuZXh0VG9rZW4/OiBzdHJpbmdcbik6IFByb21pc2U8QXVkaXRRdWVyeVJlc3VsdD4ge1xuICAvLyBUaGlzIHJlcXVpcmVzIGEgc2NhbiBvcGVyYXRpb24gc2luY2Ugd2UgZG9uJ3QgaGF2ZSBhIEdTSSB3aXRoIGp1c3QgdGltZXN0YW1wXG4gIC8vIEluIHByb2R1Y3Rpb24sIGNvbnNpZGVyIHVzaW5nIER5bmFtb0RCIFN0cmVhbXMgd2l0aCB0aW1lLXNlcmllcyBkYXRhIHBhdHRlcm5zXG4gIGNvbnN0IHBhcmFtczogYW55ID0ge1xuICAgIFRhYmxlTmFtZTogcHJvY2Vzcy5lbnYuQVVESVRfVEFCTEVfTkFNRSEsXG4gICAgRmlsdGVyRXhwcmVzc2lvbjogJyN0aW1lc3RhbXAgQkVUV0VFTiA6c3RhcnRUaW1lIEFORCA6ZW5kVGltZScsXG4gICAgRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiB7XG4gICAgICAnI3RpbWVzdGFtcCc6ICd0aW1lc3RhbXAnXG4gICAgfSxcbiAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAnOnN0YXJ0VGltZSc6IHN0YXJ0VGltZSxcbiAgICAgICc6ZW5kVGltZSc6IGVuZFRpbWVcbiAgICB9LFxuICAgIExpbWl0OiBsaW1pdFxuICB9O1xuICBcbiAgaWYgKG5leHRUb2tlbikge1xuICAgIHBhcmFtcy5FeGNsdXNpdmVTdGFydEtleSA9IEpTT04ucGFyc2UoQnVmZmVyLmZyb20obmV4dFRva2VuLCAnYmFzZTY0JykudG9TdHJpbmcoKSk7XG4gIH1cbiAgXG4gIGNvbnN0IGNvbW1hbmQgPSBuZXcgU2NhbkNvbW1hbmQocGFyYW1zKTtcbiAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChjb21tYW5kKTtcbiAgXG4gIHJldHVybiB7XG4gICAgZXZlbnRzOiByZXNwb25zZS5JdGVtcyB8fCBbXSxcbiAgICBuZXh0VG9rZW46IHJlc3BvbnNlLkxhc3RFdmFsdWF0ZWRLZXkgPyBcbiAgICAgIEJ1ZmZlci5mcm9tKEpTT04uc3RyaW5naWZ5KHJlc3BvbnNlLkxhc3RFdmFsdWF0ZWRLZXkpKS50b1N0cmluZygnYmFzZTY0JykgOiBcbiAgICAgIHVuZGVmaW5lZFxuICB9O1xufSJdfQ==