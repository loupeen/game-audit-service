"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const client_eventbridge_1 = require("@aws-sdk/client-eventbridge");
describe('Audit Service Integration Tests', () => {
    let dynamoClient;
    let docClient;
    let eventBridgeClient;
    beforeAll(() => {
        dynamoClient = new client_dynamodb_1.DynamoDBClient({
            region: process.env.AWS_REGION || 'eu-north-1'
        });
        docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(dynamoClient);
        eventBridgeClient = new client_eventbridge_1.EventBridgeClient({
            region: process.env.AWS_REGION || 'eu-north-1'
        });
    });
    describe('Event Ingestion', () => {
        test('should accept valid audit events', async () => {
            const testEvent = {
                eventId: `test-${Date.now()}`,
                timestamp: new Date().toISOString(),
                serviceName: 'loupeen.auth',
                eventType: 'Authentication Event',
                principalId: 'test-user-123',
                sourceIp: '192.168.1.100',
                userAgent: 'Mozilla/5.0 (Test Browser)',
                action: 'login',
                outcome: 'SUCCESS',
                riskLevel: 'LOW',
                details: {
                    method: 'password',
                    sessionId: 'test-session-123'
                }
            };
            // This test would normally interact with the deployed infrastructure
            // For now, we'll just validate the event structure
            expect(testEvent.eventId).toBeDefined();
            expect(testEvent.timestamp).toBeDefined();
            expect(testEvent.serviceName).toBe('loupeen.auth');
            expect(testEvent.eventType).toBe('Authentication Event');
            expect(testEvent.outcome).toBe('SUCCESS');
        });
        test('should reject invalid audit events', async () => {
            const invalidEvent = {
                // Missing required fields
                eventId: `invalid-test-${Date.now()}`,
                serviceName: 'loupeen.auth'
                // Missing timestamp, eventType, etc.
            };
            // Validate that required fields are missing
            expect(invalidEvent.timestamp).toBeUndefined();
            expect(invalidEvent.eventType).toBeUndefined();
            expect(invalidEvent.principalId).toBeUndefined();
        });
    });
    describe('Query Operations', () => {
        test('should support querying by principal', async () => {
            const principalId = 'test-user-123';
            const queryParams = {
                queryType: 'byPrincipal',
                principalId: principalId,
                startTime: new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString(), // 24 hours ago
                endTime: new Date().toISOString(),
                limit: '50'
            };
            expect(queryParams.queryType).toBe('byPrincipal');
            expect(queryParams.principalId).toBe(principalId);
            expect(queryParams.limit).toBe('50');
        });
        test('should support querying by service', async () => {
            const queryParams = {
                queryType: 'byService',
                serviceName: 'loupeen.auth',
                eventType: 'Authentication Event',
                limit: '100'
            };
            expect(queryParams.queryType).toBe('byService');
            expect(queryParams.serviceName).toBe('loupeen.auth');
            expect(queryParams.eventType).toBe('Authentication Event');
        });
        test('should support querying by risk level', async () => {
            const queryParams = {
                queryType: 'byRiskLevel',
                riskLevel: 'HIGH',
                startTime: new Date(Date.now() - 60 * 60 * 1000).toISOString(), // 1 hour ago
                endTime: new Date().toISOString(),
                limit: '25'
            };
            expect(queryParams.queryType).toBe('byRiskLevel');
            expect(queryParams.riskLevel).toBe('HIGH');
            expect(queryParams.limit).toBe('25');
        });
    });
    describe('Anomaly Detection', () => {
        test('should detect multiple failed login attempts', async () => {
            // Simulate multiple failed login events for same user
            const failedEvents = Array.from({ length: 6 }, (_, i) => ({
                eventId: `failed-login-${Date.now()}-${i}`,
                timestamp: new Date(Date.now() - (i * 60000)).toISOString(), // Spread over time
                serviceName: 'loupeen.auth',
                eventType: 'Authentication Event',
                principalId: 'suspicious-user-123',
                sourceIp: '192.168.1.200',
                action: 'login',
                outcome: 'FAILURE',
                riskLevel: 'MEDIUM',
                details: {
                    reason: 'invalid_password',
                    attemptNumber: i + 1
                }
            }));
            // Validate that we have enough failed attempts to trigger detection
            const failedAttempts = failedEvents.filter(e => e.outcome === 'FAILURE');
            expect(failedAttempts.length).toBeGreaterThanOrEqual(5);
            expect(failedAttempts.every(e => e.principalId === 'suspicious-user-123')).toBe(true);
        });
        test('should detect unusual IP activity', async () => {
            // Simulate multiple users from same IP
            const sharedIpEvents = ['user1', 'user2', 'user3', 'user4'].map((userId, i) => ({
                eventId: `shared-ip-${Date.now()}-${i}`,
                timestamp: new Date().toISOString(),
                serviceName: 'loupeen.auth',
                eventType: 'Authentication Event',
                principalId: userId,
                sourceIp: '192.168.1.300', // Same IP for all users
                action: 'login',
                outcome: 'SUCCESS',
                riskLevel: 'LOW'
            }));
            // Validate unusual IP pattern
            const uniqueIps = new Set(sharedIpEvents.map(e => e.sourceIp));
            const uniqueUsers = new Set(sharedIpEvents.map(e => e.principalId));
            expect(uniqueIps.size).toBe(1); // Only one IP
            expect(uniqueUsers.size).toBe(4); // But multiple users
        });
    });
    describe('Dashboard Metrics', () => {
        test('should support metrics aggregation', async () => {
            const metrics = {
                totalEvents: 1000,
                authenticationEvents: 800,
                authorizationEvents: 150,
                highRiskEvents: 50,
                failedAttempts: 25,
                anomaliesDetected: 3
            };
            expect(metrics.totalEvents).toBeGreaterThan(0);
            expect(metrics.authenticationEvents + metrics.authorizationEvents).toBeLessThanOrEqual(metrics.totalEvents);
            expect(metrics.highRiskEvents).toBeLessThan(metrics.totalEvents);
            expect(metrics.anomaliesDetected).toBeGreaterThanOrEqual(0);
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXVkaXQtZmxvdy50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vdGVzdC9pbnRlZ3JhdGlvbi9hdWRpdC9hdWRpdC1mbG93LnRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw4REFBMEQ7QUFDMUQsd0RBQXlGO0FBQ3pGLG9FQUFrRjtBQUVsRixRQUFRLENBQUMsaUNBQWlDLEVBQUUsR0FBRyxFQUFFO0lBQy9DLElBQUksWUFBNEIsQ0FBQztJQUNqQyxJQUFJLFNBQWlDLENBQUM7SUFDdEMsSUFBSSxpQkFBb0MsQ0FBQztJQUV6QyxTQUFTLENBQUMsR0FBRyxFQUFFO1FBQ2IsWUFBWSxHQUFHLElBQUksZ0NBQWMsQ0FBQztZQUNoQyxNQUFNLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLElBQUksWUFBWTtTQUMvQyxDQUFDLENBQUM7UUFDSCxTQUFTLEdBQUcscUNBQXNCLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQ3RELGlCQUFpQixHQUFHLElBQUksc0NBQWlCLENBQUM7WUFDeEMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxJQUFJLFlBQVk7U0FDL0MsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsaUJBQWlCLEVBQUUsR0FBRyxFQUFFO1FBQy9CLElBQUksQ0FBQyxrQ0FBa0MsRUFBRSxLQUFLLElBQUksRUFBRTtZQUNsRCxNQUFNLFNBQVMsR0FBRztnQkFDaEIsT0FBTyxFQUFFLFFBQVEsSUFBSSxDQUFDLEdBQUcsRUFBRSxFQUFFO2dCQUM3QixTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUU7Z0JBQ25DLFdBQVcsRUFBRSxjQUFjO2dCQUMzQixTQUFTLEVBQUUsc0JBQXNCO2dCQUNqQyxXQUFXLEVBQUUsZUFBZTtnQkFDNUIsUUFBUSxFQUFFLGVBQWU7Z0JBQ3pCLFNBQVMsRUFBRSw0QkFBNEI7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QztZQUVGLE1BQU0sQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQy9DLE1BQU0sQ0FBQyxPQUFPLENBQUMsb0JBQW9CLEdBQUcsT0FBTyxDQUFDLG1CQUFtQixDQUFDLENBQUMsbUJBQW1CLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQzVHLE1BQU0sQ0FBQyxPQUFPLENBQUMsY0FBYyxDQUFDLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQztZQUNqRSxNQUFNLENBQUMsT0FBTyxDQUFDLGlCQUFpQixDQUFDLENBQUMsc0JBQXNCLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDOUQsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRHluYW1vREJDbGllbnQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtZHluYW1vZGInO1xuaW1wb3J0IHsgRHluYW1vREJEb2N1bWVudENsaWVudCwgUHV0Q29tbWFuZCwgUXVlcnlDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvbGliLWR5bmFtb2RiJztcbmltcG9ydCB7IEV2ZW50QnJpZGdlQ2xpZW50LCBQdXRFdmVudHNDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWV2ZW50YnJpZGdlJztcblxuZGVzY3JpYmUoJ0F1ZGl0IFNlcnZpY2UgSW50ZWdyYXRpb24gVGVzdHMnLCAoKSA9PiB7XG4gIGxldCBkeW5hbW9DbGllbnQ6IER5bmFtb0RCQ2xpZW50O1xuICBsZXQgZG9jQ2xpZW50OiBEeW5hbW9EQkRvY3VtZW50Q2xpZW50O1xuICBsZXQgZXZlbnRCcmlkZ2VDbGllbnQ6IEV2ZW50QnJpZGdlQ2xpZW50O1xuXG4gIGJlZm9yZUFsbCgoKSA9PiB7XG4gICAgZHluYW1vQ2xpZW50ID0gbmV3IER5bmFtb0RCQ2xpZW50KHtcbiAgICAgIHJlZ2lvbjogcHJvY2Vzcy5lbnYuQVdTX1JFR0lPTiB8fCAnZXUtbm9ydGgtMSdcbiAgICB9KTtcbiAgICBkb2NDbGllbnQgPSBEeW5hbW9EQkRvY3VtZW50Q2xpZW50LmZyb20oZHluYW1vQ2xpZW50KTtcbiAgICBldmVudEJyaWRnZUNsaWVudCA9IG5ldyBFdmVudEJyaWRnZUNsaWVudCh7XG4gICAgICByZWdpb246IHByb2Nlc3MuZW52LkFXU19SRUdJT04gfHwgJ2V1LW5vcnRoLTEnXG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdFdmVudCBJbmdlc3Rpb24nLCAoKSA9PiB7XG4gICAgdGVzdCgnc2hvdWxkIGFjY2VwdCB2YWxpZCBhdWRpdCBldmVudHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCB0ZXN0RXZlbnQgPSB7XG4gICAgICAgIGV2ZW50SWQ6IGB0ZXN0LSR7RGF0ZS5ub3coKX1gLFxuICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgc2VydmljZU5hbWU6ICdsb3VwZWVuLmF1dGgnLFxuICAgICAgICBldmVudFR5cGU6ICdBdXRoZW50aWNhdGlvbiBFdmVudCcsXG4gICAgICAgIHByaW5jaXBhbElkOiAndGVzdC11c2VyLTEyMycsXG4gICAgICAgIHNvdXJjZUlwOiAnMTkyLjE2OC4xLjEwMCcsXG4gICAgICAgIHVzZXJBZ2VudDogJ01vemlsbGEvNS4wIChUZXN0IEJyb3dzZXIpJyxcbiAgICAgICAgYWN0aW9uOiAnbG9naW4nLFxuICAgICAgICBvdXRjb21lOiAnU1VDQ0VTUycsXG4gICAgICAgIHJpc2tMZXZlbDogJ0xPVycsXG4gICAgICAgIGRldGFpbHM6IHtcbiAgICAgICAgICBtZXRob2Q6ICdwYXNzd29yZCcsXG4gICAgICAgICAgc2Vzc2lvbklkOiAndGVzdC1zZXNzaW9uLTEyMydcbiAgICAgICAgfVxuICAgICAgfTtcblxuICAgICAgLy8gVGhpcyB0ZXN0IHdvdWxkIG5vcm1hbGx5IGludGVyYWN0IHdpdGggdGhlIGRlcGxveWVkIGluZnJhc3RydWN0dXJlXG4gICAgICAvLyBGb3Igbm93LCB3ZSdsbCBqdXN0IHZhbGlkYXRlIHRoZSBldmVudCBzdHJ1Y3R1cmVcbiAgICAgIGV4cGVjdCh0ZXN0RXZlbnQuZXZlbnRJZCkudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdCh0ZXN0RXZlbnQudGltZXN0YW1wKS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KHRlc3RFdmVudC5zZXJ2aWNlTmFtZSkudG9CZSgnbG91cGVlbi5hdXRoJyk7XG4gICAgICBleHBlY3QodGVzdEV2ZW50LmV2ZW50VHlwZSkudG9CZSgnQXV0aGVudGljYXRpb24gRXZlbnQnKTtcbiAgICAgIGV4cGVjdCh0ZXN0RXZlbnQub3V0Y29tZSkudG9CZSgnU1VDQ0VTUycpO1xuICAgIH0pO1xuXG4gICAgdGVzdCgnc2hvdWxkIHJlamVjdCBpbnZhbGlkIGF1ZGl0IGV2ZW50cycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGludmFsaWRFdmVudCA9IHtcbiAgICAgICAgLy8gTWlzc2luZyByZXF1aXJlZCBmaWVsZHNcbiAgICAgICAgZXZlbnRJZDogYGludmFsaWQtdGVzdC0ke0RhdGUubm93KCl9YCxcbiAgICAgICAgc2VydmljZU5hbWU6ICdsb3VwZWVuLmF1dGgnXG4gICAgICAgIC8vIE1pc3NpbmcgdGltZXN0YW1wLCBldmVudFR5cGUsIGV0Yy5cbiAgICAgIH07XG5cbiAgICAgIC8vIFZhbGlkYXRlIHRoYXQgcmVxdWlyZWQgZmllbGRzIGFyZSBtaXNzaW5nXG4gICAgICBleHBlY3QoKGludmFsaWRFdmVudCBhcyBhbnkpLnRpbWVzdGFtcCkudG9CZVVuZGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KChpbnZhbGlkRXZlbnQgYXMgYW55KS5ldmVudFR5cGUpLnRvQmVVbmRlZmluZWQoKTtcbiAgICAgIGV4cGVjdCgoaW52YWxpZEV2ZW50IGFzIGFueSkucHJpbmNpcGFsSWQpLnRvQmVVbmRlZmluZWQoKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ1F1ZXJ5IE9wZXJhdGlvbnMnLCAoKSA9PiB7XG4gICAgdGVzdCgnc2hvdWxkIHN1cHBvcnQgcXVlcnlpbmcgYnkgcHJpbmNpcGFsJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcHJpbmNpcGFsSWQgPSAndGVzdC11c2VyLTEyMyc7XG4gICAgICBjb25zdCBxdWVyeVBhcmFtcyA9IHtcbiAgICAgICAgcXVlcnlUeXBlOiAnYnlQcmluY2lwYWwnLFxuICAgICAgICBwcmluY2lwYWxJZDogcHJpbmNpcGFsSWQsXG4gICAgICAgIHN0YXJ0VGltZTogbmV3IERhdGUoRGF0ZS5ub3coKSAtIDI0ICogNjAgKiA2MCAqIDEwMDApLnRvSVNPU3RyaW5nKCksIC8vIDI0IGhvdXJzIGFnb1xuICAgICAgICBlbmRUaW1lOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICAgIGxpbWl0OiAnNTAnXG4gICAgICB9O1xuXG4gICAgICBleHBlY3QocXVlcnlQYXJhbXMucXVlcnlUeXBlKS50b0JlKCdieVByaW5jaXBhbCcpO1xuICAgICAgZXhwZWN0KHF1ZXJ5UGFyYW1zLnByaW5jaXBhbElkKS50b0JlKHByaW5jaXBhbElkKTtcbiAgICAgIGV4cGVjdChxdWVyeVBhcmFtcy5saW1pdCkudG9CZSgnNTAnKTtcbiAgICB9KTtcblxuICAgIHRlc3QoJ3Nob3VsZCBzdXBwb3J0IHF1ZXJ5aW5nIGJ5IHNlcnZpY2UnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBxdWVyeVBhcmFtcyA9IHtcbiAgICAgICAgcXVlcnlUeXBlOiAnYnlTZXJ2aWNlJyxcbiAgICAgICAgc2VydmljZU5hbWU6ICdsb3VwZWVuLmF1dGgnLFxuICAgICAgICBldmVudFR5cGU6ICdBdXRoZW50aWNhdGlvbiBFdmVudCcsXG4gICAgICAgIGxpbWl0OiAnMTAwJ1xuICAgICAgfTtcblxuICAgICAgZXhwZWN0KHF1ZXJ5UGFyYW1zLnF1ZXJ5VHlwZSkudG9CZSgnYnlTZXJ2aWNlJyk7XG4gICAgICBleHBlY3QocXVlcnlQYXJhbXMuc2VydmljZU5hbWUpLnRvQmUoJ2xvdXBlZW4uYXV0aCcpO1xuICAgICAgZXhwZWN0KHF1ZXJ5UGFyYW1zLmV2ZW50VHlwZSkudG9CZSgnQXV0aGVudGljYXRpb24gRXZlbnQnKTtcbiAgICB9KTtcblxuICAgIHRlc3QoJ3Nob3VsZCBzdXBwb3J0IHF1ZXJ5aW5nIGJ5IHJpc2sgbGV2ZWwnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBxdWVyeVBhcmFtcyA9IHtcbiAgICAgICAgcXVlcnlUeXBlOiAnYnlSaXNrTGV2ZWwnLFxuICAgICAgICByaXNrTGV2ZWw6ICdISUdIJyxcbiAgICAgICAgc3RhcnRUaW1lOiBuZXcgRGF0ZShEYXRlLm5vdygpIC0gNjAgKiA2MCAqIDEwMDApLnRvSVNPU3RyaW5nKCksIC8vIDEgaG91ciBhZ29cbiAgICAgICAgZW5kVGltZTogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgICBsaW1pdDogJzI1J1xuICAgICAgfTtcblxuICAgICAgZXhwZWN0KHF1ZXJ5UGFyYW1zLnF1ZXJ5VHlwZSkudG9CZSgnYnlSaXNrTGV2ZWwnKTtcbiAgICAgIGV4cGVjdChxdWVyeVBhcmFtcy5yaXNrTGV2ZWwpLnRvQmUoJ0hJR0gnKTtcbiAgICAgIGV4cGVjdChxdWVyeVBhcmFtcy5saW1pdCkudG9CZSgnMjUnKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ0Fub21hbHkgRGV0ZWN0aW9uJywgKCkgPT4ge1xuICAgIHRlc3QoJ3Nob3VsZCBkZXRlY3QgbXVsdGlwbGUgZmFpbGVkIGxvZ2luIGF0dGVtcHRzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gU2ltdWxhdGUgbXVsdGlwbGUgZmFpbGVkIGxvZ2luIGV2ZW50cyBmb3Igc2FtZSB1c2VyXG4gICAgICBjb25zdCBmYWlsZWRFdmVudHMgPSBBcnJheS5mcm9tKHsgbGVuZ3RoOiA2IH0sIChfLCBpKSA9PiAoe1xuICAgICAgICBldmVudElkOiBgZmFpbGVkLWxvZ2luLSR7RGF0ZS5ub3coKX0tJHtpfWAsXG4gICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoRGF0ZS5ub3coKSAtIChpICogNjAwMDApKS50b0lTT1N0cmluZygpLCAvLyBTcHJlYWQgb3ZlciB0aW1lXG4gICAgICAgIHNlcnZpY2VOYW1lOiAnbG91cGVlbi5hdXRoJyxcbiAgICAgICAgZXZlbnRUeXBlOiAnQXV0aGVudGljYXRpb24gRXZlbnQnLFxuICAgICAgICBwcmluY2lwYWxJZDogJ3N1c3BpY2lvdXMtdXNlci0xMjMnLFxuICAgICAgICBzb3VyY2VJcDogJzE5Mi4xNjguMS4yMDAnLFxuICAgICAgICBhY3Rpb246ICdsb2dpbicsXG4gICAgICAgIG91dGNvbWU6ICdGQUlMVVJFJyxcbiAgICAgICAgcmlza0xldmVsOiAnTUVESVVNJyxcbiAgICAgICAgZGV0YWlsczoge1xuICAgICAgICAgIHJlYXNvbjogJ2ludmFsaWRfcGFzc3dvcmQnLFxuICAgICAgICAgIGF0dGVtcHROdW1iZXI6IGkgKyAxXG4gICAgICAgIH1cbiAgICAgIH0pKTtcblxuICAgICAgLy8gVmFsaWRhdGUgdGhhdCB3ZSBoYXZlIGVub3VnaCBmYWlsZWQgYXR0ZW1wdHMgdG8gdHJpZ2dlciBkZXRlY3Rpb25cbiAgICAgIGNvbnN0IGZhaWxlZEF0dGVtcHRzID0gZmFpbGVkRXZlbnRzLmZpbHRlcihlID0+IGUub3V0Y29tZSA9PT0gJ0ZBSUxVUkUnKTtcbiAgICAgIGV4cGVjdChmYWlsZWRBdHRlbXB0cy5sZW5ndGgpLnRvQmVHcmVhdGVyVGhhbk9yRXF1YWwoNSk7XG4gICAgICBleHBlY3QoZmFpbGVkQXR0ZW1wdHMuZXZlcnkoZSA9PiBlLnByaW5jaXBhbElkID09PSAnc3VzcGljaW91cy11c2VyLTEyMycpKS50b0JlKHRydWUpO1xuICAgIH0pO1xuXG4gICAgdGVzdCgnc2hvdWxkIGRldGVjdCB1bnVzdWFsIElQIGFjdGl2aXR5JywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gU2ltdWxhdGUgbXVsdGlwbGUgdXNlcnMgZnJvbSBzYW1lIElQXG4gICAgICBjb25zdCBzaGFyZWRJcEV2ZW50cyA9IFsndXNlcjEnLCAndXNlcjInLCAndXNlcjMnLCAndXNlcjQnXS5tYXAoKHVzZXJJZCwgaSkgPT4gKHtcbiAgICAgICAgZXZlbnRJZDogYHNoYXJlZC1pcC0ke0RhdGUubm93KCl9LSR7aX1gLFxuICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgc2VydmljZU5hbWU6ICdsb3VwZWVuLmF1dGgnLFxuICAgICAgICBldmVudFR5cGU6ICdBdXRoZW50aWNhdGlvbiBFdmVudCcsXG4gICAgICAgIHByaW5jaXBhbElkOiB1c2VySWQsXG4gICAgICAgIHNvdXJjZUlwOiAnMTkyLjE2OC4xLjMwMCcsIC8vIFNhbWUgSVAgZm9yIGFsbCB1c2Vyc1xuICAgICAgICBhY3Rpb246ICdsb2dpbicsXG4gICAgICAgIG91dGNvbWU6ICdTVUNDRVNTJyxcbiAgICAgICAgcmlza0xldmVsOiAnTE9XJ1xuICAgICAgfSkpO1xuXG4gICAgICAvLyBWYWxpZGF0ZSB1bnVzdWFsIElQIHBhdHRlcm5cbiAgICAgIGNvbnN0IHVuaXF1ZUlwcyA9IG5ldyBTZXQoc2hhcmVkSXBFdmVudHMubWFwKGUgPT4gZS5zb3VyY2VJcCkpO1xuICAgICAgY29uc3QgdW5pcXVlVXNlcnMgPSBuZXcgU2V0KHNoYXJlZElwRXZlbnRzLm1hcChlID0+IGUucHJpbmNpcGFsSWQpKTtcbiAgICAgIFxuICAgICAgZXhwZWN0KHVuaXF1ZUlwcy5zaXplKS50b0JlKDEpOyAvLyBPbmx5IG9uZSBJUFxuICAgICAgZXhwZWN0KHVuaXF1ZVVzZXJzLnNpemUpLnRvQmUoNCk7IC8vIEJ1dCBtdWx0aXBsZSB1c2Vyc1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnRGFzaGJvYXJkIE1ldHJpY3MnLCAoKSA9PiB7XG4gICAgdGVzdCgnc2hvdWxkIHN1cHBvcnQgbWV0cmljcyBhZ2dyZWdhdGlvbicsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IG1ldHJpY3MgPSB7XG4gICAgICAgIHRvdGFsRXZlbnRzOiAxMDAwLFxuICAgICAgICBhdXRoZW50aWNhdGlvbkV2ZW50czogODAwLFxuICAgICAgICBhdXRob3JpemF0aW9uRXZlbnRzOiAxNTAsXG4gICAgICAgIGhpZ2hSaXNrRXZlbnRzOiA1MCxcbiAgICAgICAgZmFpbGVkQXR0ZW1wdHM6IDI1LFxuICAgICAgICBhbm9tYWxpZXNEZXRlY3RlZDogM1xuICAgICAgfTtcblxuICAgICAgZXhwZWN0KG1ldHJpY3MudG90YWxFdmVudHMpLnRvQmVHcmVhdGVyVGhhbigwKTtcbiAgICAgIGV4cGVjdChtZXRyaWNzLmF1dGhlbnRpY2F0aW9uRXZlbnRzICsgbWV0cmljcy5hdXRob3JpemF0aW9uRXZlbnRzKS50b0JlTGVzc1RoYW5PckVxdWFsKG1ldHJpY3MudG90YWxFdmVudHMpO1xuICAgICAgZXhwZWN0KG1ldHJpY3MuaGlnaFJpc2tFdmVudHMpLnRvQmVMZXNzVGhhbihtZXRyaWNzLnRvdGFsRXZlbnRzKTtcbiAgICAgIGV4cGVjdChtZXRyaWNzLmFub21hbGllc0RldGVjdGVkKS50b0JlR3JlYXRlclRoYW5PckVxdWFsKDApO1xuICAgIH0pO1xuICB9KTtcbn0pOyJdfQ==